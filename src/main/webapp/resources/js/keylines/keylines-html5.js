//
//     KeyLines v1.9.17-1607
//
//     Copyright Â© 2011-2012 Cambridge Intelligence Limited. 
//     All rights reserved.
//

var KeyLines=KeyLines||{};


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Events={}),a.createEventBus=function(){function f(a,b){var c=(new Date).toString()+" Function bound to '"+a+"' threw error: "+b.toString();e.push(c),e.length>d&&e.shift()}function g(a,b,c,d,e,f){function m(a){return((i*a+h)*a+g)*a}function n(a,b){var c=o(a,b);return((l*c+k)*c+j)*c}function o(a,b){var c,d,e,f,j,k;for(e=a,k=0;k<8;k++){f=m(e)-a;if(Math.abs(f)<b)return e;j=(3*i*e+2*h)*e+g;if(Math.abs(j)<1e-6)break;e-=f/j}c=0,d=1,e=a;if(e<c)return c;if(e>d)return d;while(c<d){f=m(e);if(Math.abs(f-a)<b)return e;a>f?c=e:d=e,e=(d-c)/2+c}return e}var g=3*b,h=3*(d-b)-g,i=1-g-h,j=3*c,k=3*(e-c)-j,l=1-j-k;return n(a,1/(200*f))}var a={},b;a.bind=function(a,c,d){b=b||{},b[a]=b[a]||[],b[a].push([c,d])},a.unbind=function(a,c){if(!b)return;if(!a)b={};else if(!c)b[a]=[];else if(b[a]){var d=[];for(var e=0;e<b[a].length;e++)c!==b[a][e][0]&&d.push(b[a][e]);b[a]=d}};var c=a.trigger=function(a){var c=!1;if(b){var d=2,e;while(d--){var g=d?a:"all",h=[],i=d?1:0;for(e=i;e<arguments.length;e++)h.push(arguments[e]);if(b[g])for(e=0;e<b[g].length;e++){var j=b[g][e];try{c=j[0].apply(j[1]||this,h)||c}catch(k){f(a,k)}}}}return c};a.getErrors=function(){return e};var d=10,e=[];a.linearEasing=function(a){return a},a.cubicEasing=function(a){return a<0?0:a>1?1:g(a,.25,.01,.25,1,1)};var h=1;return a.atanEasing=function(a){return Math.atan(h*(a-.5))/(2*Math.atan(.5*h))+.5},a}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.View={});var b=a.createView=function(a,c,d,e){function E(){return G(j*w)}function F(){return G(j/w)}function K(a,b,c,d,e){var f=d.instructionPool();return a.generate(f,b,g,c,null,null,e),f}var f=typeof KeyLinesRequire!="undefined"?require("./util"):KeyLines.Util,g={},h,i,j,k,l,m=c,n=d,o=e?e:1,p=g.scaleFactor=function(a){return a&&(o=a),o},q=g.scale=function(a){return Math.floor(o*a)},r=g.unscale=function(a){return Math.floor(a/o)};g.settings=function(){return{width:m,height:n,zoom:j,offsetX:k,offsetY:l}},g.fromSettingsDirect=function(a,b,c,d){return Q(j,a.zoom,a.offsetX-k,a.offsetY-l,b,c,d)},g.fromOldSettings=function(c,d,e,f){if(d){var g=b(a,c.width,c.height);g.setZoom(c.zoom,!1),g.offsetX=c.offsetX,g.offsetY=c.offsetY;var h={x1:g.newToOldX(0),y1:g.newToOldY(0),x2:g.newToOldX(g.width()),y2:g.newToOldY(g.height())};return I(h,e,!1,!1,!1,f)}H(c.zoom,!1),k=c.offsetX,l=c.offsetY},g.width=function(a){return a&&(m=a),m},g.height=function(a){return a&&(n=a),n};var s=g.x=g.oldToNewX=function(a){return Math.floor(((a-h)*j+k)*o)},t=g.y=g.oldToNewY=function(a){return Math.floor(((a-i)*j+l)*o)},u=g.newToOldX=function(a){return Math.floor((a/o-k)/j+h)},v=g.newToOldY=function(a){return Math.floor((a/o-l)/j+i)};g.w=function(a){return Math.max(1,Math.floor(a*Math.min(j,A)*o))},g.dim=function(a){return Math.floor(a*Math.min(j,A)*o)},g.dim2=function(a){return Math.floor(a*j*o)},g.undim=function(a){return Math.floor(a/(Math.min(j,A)*o))};var w=1.4,x=4,y=.05,z=200,A=Infinity,B=100;g.maxZoom=function(){return x},g.minZoom=function(){return y},g.setMaxItemZoom=function(a){A=a?a:Infinity},g.getMaxItemZoom=function(){return A};var C=g.zoomIn=function(a,b,c){var d=E();return M(d,o*m/2,o*n/2,a,b,c)},D=g.zoomOut=function(a,b,c){var d=F();return M(d,o*m/2,o*n/2,a,b,c)},G=function(a){return Math.min(x,Math.max(a,y))},H=g.setZoom=function(a,b,c,d){var e=G(a);return M(e,o*m/2,o*n/2,b,c,d)};g.wheelToPosition=function(a,b,c){var d=a>0?E():F();return M(d,b,c,!0,200)},g.fitWorldExtents=function(a,b,c,d,e,g,h){if(!a)return f.invoke(h),null;var i={x1:s(a.x1),y1:t(a.y1),x2:s(a.x2),y2:t(a.y2)};return I(i,b,c,d,e,g,!1,h)};var I=g.fitExtents=function(a,b,c,d,e,f,g,p){var q=(a.y2-a.y1)/(a.x2-a.x1),r=n/m,s;if(q>r){var t=e?n/8:0;s=j*(n-t)/(a.y2-a.y1)}else{var w=e?m/8:0;s=j*(m-w)/(a.x2-a.x1)}s*=o,c&&(s=G(s)),d&&s>1&&(s=1);var x=(a.x1+a.x2)/2,y=(a.y1+a.y2)/2,z=u(x),A=v(y),B=m/2-(z-h)*s,C=n/2-(A-i)*s;return Q(j,s,B-k,C-l,b,f,p,g)};g.fitToSelection=function(a,b,c,d,e,f,h,i){var j=d.instructionPool();return a.generateSelection(j,b,g,c,undefined,i),J(b,j,d,e,f,h)};var J=function(a,b,c,d,e,f){var g=c.getUnionExtents3(a,b);return g?I(g,d,!0,!0,!0,e,!1,f):null},L=g.modelExtents=function(a,b,c,d,e){var f=A;A=Infinity;var g=K(a,b,c,d,e);return A=f,d.getUnionExtents3(b,g)};g.fitToModel=function(a,b,c,d,e,f,g,h){var i=K(a,b,c,d,h);return J(b,i,d,e,f,g)},g.fitModelHeight=function(a,b,c,d,e,f,h,i){var j=K(a,b,c,d,i),k=d.getUnionExtents3(b,j);if(k)return k.x1=k.x2=g.width()/2,I(k,e,!0,!0,!0,f,!1,h)};var M=g.zoomToPosition=function(a,b,c,d,e,f){a=G(a);var g=u(b),m=v(c),n=b/o-(g-h)*a,p=c/o-(m-i)*a;return Q(j,a,n-k,p-l,d,e,f)},N=g.reset=function(b,c){h=421,i=298,b?Q(j,1,421-k,298-l,!0):(k=421,l=298,j=1),a&&!c&&a.trigger("zoom1to1")},O=g.zoom=function(){return j};g.offsetX=function(){return k},g.offsetY=function(){return l},g.panLeft=function(a,b,c){return P(B,0,a,!1,b,c)},g.panRight=function(a,b,c){return P(-B,0,a,!1,b,c)},g.panUp=function(a,b,c){return P(0,B,a,!1,b,c)},g.panDown=function(a,b,c){return P(0,-B,a,!1,b,c)};var P=g.panBy=function(a,b,c,d,e,f){return Q(j,j,a,b,c,e,f,d)},Q=function(b,c,d,e,g,h,i,m){if(g)return R(b,c,d,e,h,i);k+=Math.floor(d),l+=Math.floor(e),j=c,a&&!m&&a.trigger("viewchange"),f.invoke(i)},R=function(b,c,d,e,g,h){g||(g=z);var i=g,m=k,n=l;return{animate:function(o){i-=o;var p=a.atanEasing(Math.max(0,Math.min(1,(g-i)/g)));k=m+p*d,l=n+p*e,j=G(b+p*(c-b));var q=i>0;return q||(a.trigger("viewchange"),f.invoke(h)),q}}},S=function(){var b=.1;return{animate:function(c){var d=U===0&&V===0;return k+=c*b*U,l+=c*b*V,T=!d,d||a.trigger("viewchange"),!d}}},T,U,V;return g.cancelScroll=function(){U=V=0},g.maybeScroll=function(a,b){var c=q(50);U=0,V=0,a<c&&(U=1),a>q(m)-c&&(U=-1),b<c&&(V=1),b>q(n)-c&&(V=-1);if(U!==0||V!==0)if(!T)return T=!0,S()},N(),g}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Draggers={}),a.createDraggers=function(a){var b=typeof KeyLinesRequire!="undefined"?require("./util"):KeyLines.Util,c={};return c.primitiveMover=function(c,d,e,f,g,h,i,j,k,l){function p(a,b){return{dx:a-j,dy:b-k}}function q(a,c,d,e){var f={},g;if(i.length>0){f.x1=f.x2=f.y1=f.y2=0;for(var h=0;h<i.length;h++){g=i[h];var j=g.charAt(0)==="x"?a:c;f[g]=j}d&&(f.x1!==0&&(f.x2=-f.x1),f.x2!==0&&(f.x1=-f.x2),f.y1!==0&&(f.y2=-f.y1),f.y2!==0&&(f.y1=-f.y2))}else e&&(a=Math.abs(a)>Math.abs(c)?a:0,c=a!==0?0:c),f.x1=f.x2=a,f.y1=f.y2=c;var k={},l=["x1","y1","x2","y2"];for(var n=0;n<l.length;n++)g=l[n],k[g]=m[g]+f[g];if(e){var o=m.x2-m.x1,p=m.y2-m.y1;if(Math.abs(o)>0&&Math.abs(p)>0){var q=p/o,r=k.x2-k.x1,s=k.y2-k.y1,t=Math.abs(a)>Math.abs(c),u;if(t){var v=Math.floor(q*(o+r)-p)-s;d||!b.contains(i,"y1")&&!b.contains(i,"y2")?(u=Math.floor(v/2),k.y1-=u,k.y2+=u):(b.contains(i,"y1")&&(k.y1-=v),b.contains(i,"y2")&&(k.y2+=v))}else{var w=Math.floor((p+s)/q-o)-r;d||!b.contains(i,"x1")&&!b.contains(i,"x2")?(u=Math.floor(w/2),k.x1-=u,k.x2+=u):(b.contains(i,"x1")&&(k.x1-=w),b.contains(i,"x2")&&(k.x2+=w))}}}return k}function r(a,b,c,d){var e=p(a,b);return q(e.dx,e.dy,c,d)}if(a.trigger("dragstart","resize",f,e.unscale(j),e.unscale(k),null))return;var m=c.extents(d,g),n={};for(var o in g)n[o]=g[o];c.setAlpha(n,.5);var s={scrollable:!0,getCursor:function(a,b){return h?"crosshair":"move"},generate:function(a){a.copyPrimitive(n)},dragMove:function(a,b,e,f){var g=r(a,b,e,f);c.setExtents(n,g.x1,g.y1,g.x2,g.y2,d)},endDrag:function(b,h,i,j,k){e.cancelScroll();var m=a.trigger("dragend","resize",f,e.unscale(h),e.unscale(i));if(!m&&b){var n=r(h,i,j,k);c.setExtents(g,n.x1,n.y1,n.x2,n.y2,d),l(g)}a.trigger("dragcomplete","resize",f,e.unscale(h),e.unscale(i))}};return s},c.createDefaultDragger=function(c,d,e,f,g,h,i){function n(a){return k&&k[a]}function t(){for(var a in c){var b=j?d(a)||n(a):!0;b&&q[a]&&(c[a].x=q[a].x+s.dx,c[a].y=q[a].y+s.dy)}}function u(){for(var a in c)q[a]&&(c[a].x=q[a].x,c[a].y=q[a].y)}function w(a,b){return v=v||Math.abs(h-a)>10||Math.abs(i-b)>10,a=f?f.newToOldX(a):a,b=f?f.newToOldY(b):b,{dx:v?a-o:0,dy:v?b-p:0}}function x(){return j?"move":"hand"}var j=g!==null,k=null,l=b.rawId(g),m=a.trigger("dragstart",x(),l,f.unscale(h),f.unscale(i),b.subId(g));if(m)if(b.isArray(m))k=b.makeIdMap(m);else return;var o=f?f.newToOldX(h):h,p=f?f.newToOldY(i):i,q={};for(var r in c)q[r]={x:c[r].x,y:c[r].y};var s=w(h,i),v=!1,y,z,A={scrollable:j,animate:function(a){t()},excludeHit:function(){var a={};return g!==null&&(a[g]=1),a},getCursor:function(a,b){return"move"},dragMove:function(a,b,c,d){s=w(a,b)},mouseMoved:function(a){return a&&(y=!0),y},afterDraw:function(c,d,e){y=!1;var g=b.rawId(c);if(l===g)return;typeof z=="undefined"?z=g:g!==z&&(a.trigger("dragover",g,f.unscale(d),f.unscale(e),b.subId(c)),z=g)},endDrag:function(c,d,e,h,i){f.cancelScroll();var j=a.trigger("dragend",x(),b.rawId(g),f.unscale(d),f.unscale(e));j?u():c&&v?(u(),a.trigger("prechange","move"),s=w(d,e),t()):u(),a.trigger("dragcomplete",x(),b.rawId(g),f.unscale(d),f.unscale(e))}};return A},c.createLinkEndDragger=function(c,d,e,f,g,h,i,j,k){function p(a,b){f[g[h]].x=a,f[g[h]].y=b}function u(a,b){return a=e?e.newToOldX(a):a,b=e?e.newToOldY(b):b,{dx:a-l,dy:b-m}}if(a.trigger("dragstart","dummy",k,e.unscale(i),e.unscale(j),null))return!1;var l=e?e.newToOldX(i):i,m=e?e.newToOldY(j):j,n=f[g[h]].x,o=f[g[h]].y,q=u(i,j),r=i,s=j,t=null,v={scrollable:!0,animate:function(a){p(n+q.dx,o+q.dy)},getCursor:function(a,b){return"move"},dragMove:function(a,b,d,e){q=u(a,b),r=a,s=b,t=c.hittest(a,b),!t},endDrag:function(c,i,j,k,l){e.cancelScroll();var m=a.trigger("dragend","dummy",t,e.unscale(i),e.unscale(j));m||(c?(p(n,o),a.trigger("prechange","move"),d.isNode(t)?(delete f[g[h]],g[h]=b.rawId(t)):(q=u(i,j),p(n+q.dx,o+q.dy))):p(n,o)),a.trigger("dragcomplete","dummy",t,e.unscale(i),e.unscale(j))}};return v},c.createLinkDragger=function(c,d,e,f,g,h,i){function j(a,b,c,d,e,f){return((c-a)*(b-f)-(a-e)*(d-b))/Math.sqrt((c-a)*(c-a)+(d-b)*(d-b))}function k(a,b,c,d,e,f){return{x:((e-c)*Math.cos(b)-(f-d)*Math.sin(b))/a,y:((e-c)*Math.sin(b)+(f-d)*Math.cos(b))/a}}function l(a,b,c,d,e,f){var g=Math.sqrt((c-a)*(c-a)+(d-b)*(d-b)),h=Math.atan2(d-b,c-a),i=k(g,-h,a,b,e,f);return i.x}function p(a,b){var d=e.newToOldX(a),g=e.newToOldY(b),h=c("x1",f),i=c("y1",f),k=c("x2",f),p=c("y2",f),q=j(h,i,k,p,d,g),r=l(h,i,k,p,d,g);o&&Math.abs(q-m)>8&&(o=!1),o||(Math.abs(q)<12&&(q=0),n=q)}function q(){f.off=n}if(a.trigger("dragstart","offset",i,e.unscale(g),e.unscale(h),b.subId(i)))return!1;var m=f.off?f.off:0,n=m,o=!0,r={scrollable:!0,animate:function(a){q()},getCursor:function(a,b){return"move"},dragMove:function(a,b,c,d){p(a,b)},endDrag:function(b,c,d,g,h){e.cancelScroll();var j=a.trigger("dragend","offset",i,e.unscale(c),e.unscale(d));j||(b?(f.off=m,a.trigger("prechange","offset"),p(c,d),q()):f.off=m),a.trigger("dragcomplete","offset",i,e.unscale(c),e.unscale(d))}};return r},c}})();


(function(){function d(){function j(a){var b={};if(a)for(var c=0;c<a.length;c++)b[a[c]]=1;return b}var d={},e=[],f,g;for(var h in c)e.push(b());var i=d.layer=function(a){return typeof a!="undefined"&&(g=a,f=e[g]),g};return i(c.NODES),d.reset=function(a){var b=j(a);for(var c=0;c<e.length;c++)(!a||b[c])&&e[c].reset()},d.getLast=function(){return f.getLast()},d.each=function(a,b){var c=j(b);for(var d=0;d<e.length;d++)(!b||c[d])&&e[d].each(a)},d.line=function(b,c,d,e,g,h,i){var j=f.getNext();j.p=a.primitives.line,j.x1=b,j.y1=c,j.x2=d,j.y2=e,j.c=g,j.w=h,j.id=i},d.circle=function(b,c,d,e,g,h,i,j){var k=f.getNext();k.p=a.primitives.circle,k.x=b,k.y=c,k.r=d,k.bc=e,k.bw=g,k.fc=h,k.fi=i,k.id=j},d.arc=function(b,c,d,e,g,h,i,j){var k=f.getNext();k.p=a.primitives.arc,k.x=b,k.y=c,k.r=d,k.sa=e,k.ea=g,k.bc=h,k.bw=i,k.id=j},d.text=function(b,c,d,e,g,h,i,j){var k=f.getNext();k.p=a.primitives.text,k.x=b,k.y=c,k.t=d,k.c=e,k.fs=g,k.bo=h,k.ff=j,k.id=i},d.image=function(b,c,d,e,g,h,i){var j=f.getNext();j.p=a.primitives.image,j.x1=b,j.y1=c,j.x2=d,j.y2=e,j.u=g,j.id=h,j.s=i},d.rect=function(b,c,d,e,g,h,i,j,k){var l=f.getNext();l.p=a.primitives.rect,l.x1=b,l.y1=c,l.x2=d,l.y2=e,l.bc=g,l.bw=h,l.fc=i,l.fi=j,l.id=k},d.round=function(b,c,d,e,g,h,i,j,k,l){var m=f.getNext();m.p=a.primitives.round,m.x1=b,m.y1=c,m.x2=d,m.y2=e,m.r=g,m.bc=h,m.bw=i,m.fc=j,m.fi=k,m.id=l},d.triangle=function(b,c,d,e,g,h,i,j,k,l,m){var n=f.getNext();n.p=a.primitives.triangle,n.x1=b,n.y1=c,n.x2=d,n.y2=e,n.x3=g,n.y3=h,n.bc=i,n.bw=j,n.fc=k,n.fi=l,n.id=m},d.path=function(b,c,d,e,g){var h=f.getNext();h.p=a.primitives.path,h.cmds=b,h.pts=c,h.c=d,h.w=e,h.id=g},d.copyPrimitive=function(a){var b=f.getNext();for(var c in a)b[c]=a[c]},d}function H(b,c,d){switch(d.p){case a.primitives.circle:J(b,d.x,d.y,d.r,d.bc,d.bw,d.fc,d.fi);break;case a.primitives.arc:K(b,d.x,d.y,d.r,d.sa,d.ea,d.bc,d.bw);break;case a.primitives.line:L(b,d.x1,d.y1,d.x2,d.y2,d.c,d.w);break;case a.primitives.text:M(b,d.x,d.y,d.t,d.c,d.fs,d.bo,d.ff);break;case a.primitives.image:O(b,c[d.u],d.x1,d.y1,d.x2,d.y2,d.s);break;case a.primitives.rect:N(b,d.x1,d.y1,d.x2,d.y2,d.bc,d.bw,d.fc,d.fi);break;case a.primitives.round:P(b,d.x1,d.y1,d.x2,d.y2,d.r,d.bc,d.bw,d.fc,d.fi);break;case a.primitives.triangle:Q(b,d.x1,d.y1,d.x2,d.y2,d.x3,d.y3,d.bc,d.bw,d.fc,d.fi);break;case a.primitives.path:I(b,d.cmds,d.pts,d.c,d.w)}}function I(a,b,c,d,e){if(a.hasOwnProperty("doPath"))a.doPath(b,c,d,e);else{e>=0&&(a.lineWidth=e,a.strokeStyle=d,a.beginPath());var f=0;for(var g=0;g<b.length;g++)switch(b[g]){case 1:a.moveTo(c[f++],c[f++]);break;case 2:a.lineTo(c[f++],c[f++]);break;case 3:a.quadraticCurveTo(c[f++],c[f++],c[f++],c[f++])}e>=0&&(a.stroke(),a.closePath())}}function J(a,b,c,d,e,g,h,i){i?a.fillStyle=h:a.fillStyle=f.transparent,g<0?a.strokeStyle=f.transparent:(a.lineWidth=g,a.strokeStyle=e),a.beginPath(),a.arc(b,c,d,0,Math.PI*2,!0),a.closePath(),i&&a.fill(),g>=0&&a.stroke()}function K(a,b,c,d,e,f,g,h){a.lineWidth=h,a.strokeStyle=g,a.beginPath(),a.arc(b,c,d,e,f,!1),a.stroke(),a.closePath()}function L(a,b,c,d,e,f,g){a.lineWidth=g,a.lineCap="butt",a.strokeStyle=f,a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.stroke(),a.closePath()}function M(a,b,c,d,e,f,g,h){s(a,f,g,h),a.fillStyle=e,a.fillText(d,b,c)}function N(a,b,c,d,e,f,g,h,i){i&&(a.fillStyle=h,a.fillRect(b,c,d-b,e-c)),g>=0&&(a.lineWidth=g,a.strokeStyle=f,a.strokeRect(b,c,d-b,e-c))}function O(a,b,c,d,e,f,g){var h=b[g?g:"im"];a.drawImage(h,0,0,h.width,h.height,c,d,e-c,f-d)}function P(a,b,c,d,e,f,g,h,i,j){a.beginPath(),a.moveTo(b+f,c),a.arcTo(d,c,d,e,f),a.arcTo(d,e,b,e,f),a.arcTo(b,e,b,c,f),a.arcTo(b,c,b+f,c,f),a.closePath(),j&&(a.fillStyle=i,a.fill()),h>=0&&(a.lineWidth=h,a.strokeStyle=g,a.stroke())}function Q(a,b,c,d,e,f,g,h,i,j,k){if(a.drawTriangle){a.drawTriangle(b,c,d,e,f,g,h,i,j,k);return}a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.lineTo(f,g),a.lineTo(b,c),a.closePath(),k&&(a.fillStyle=j,a.fill()),i>=0&&(a.lineWidth=i,a.strokeStyle=h,a.stroke())}function R(a,b){var c={};for(var d in a){var e=a[d],f=b(e.width,e.height),g=f.getContext("2d");g.fillStyle="rgb(255, 0, 254)",g.fillRect(0,0,e.width,e.height),g.drawImage(e,0,0,e.width,e.height,0,0,e.width,e.height),c[d]=f}return c}function S(a,b,c){a/=255,b/=255,c/=255;var d=Math.max(a,b,c),e=Math.min(a,b,c),f,g,h=(d+e)/2;if(d===e)f=g=0;else{var i=d-e;g=h>.5?i/(2-d-e):i/(d+e);switch(d){case a:f=(b-c)/i+(b<c?6:0);break;case b:f=(c-a)/i+2;break;case c:f=(a-b)/i+4}f/=6}return[f,g,h]}function T(a,b,c){return c<0&&(c+=1),c>1&&(c-=1),c<1/6?a+(b-a)*6*c:c<.5?b:c<2/3?a+(b-a)*(2/3-c)*6:a}function U(a,b,c){var d,e,f;if(b===0)d=e=f=c;else{var g=c<.5?c*(1+b):c+b-c*b,h=2*c-g;d=T(h,g,a+1/3),e=T(h,g,a),f=T(h,g,a-1/3)}return[Math.floor(d*255),Math.floor(e*255),Math.floor(f*255)]}function V(b,c,d){var e=d(b.width,b.height),f=e.getContext("2d"),g=a.convertrgb(c),h=b.getContext("2d").getImageData(0,0,b.width,b.height),i=h.data;for(var j=0;j<i.length;j+=4)i[j]===255&&i[j+1]===0&&i[j+2]===254?(h.data[j]=0,h.data[j+1]=0,h.data[j+2]=0,h.data[j+3]=0):(h.data[j]=g[0],h.data[j+1]=g[1],h.data[j+2]=g[2],h.data[j+3]=255);return f.putImageData(h,0,0),e}var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Rendering={});var b=function(){function d(){return a[b]||(a[b]={}),a[b++]}var a=[],b=0,c="out of range error";return{reset:function(){b=0},each:function(c){for(var d=0;d<b;d++)c(a[d])},getNext:d,getLast:function(){if(b>0)return a[b-1];throw c}}};a.pool=function(){return b()};var c=a.layers={UNDERLAYS:0,BGSHAPES:1,SHAPES:2,HANDLES:3,BGLINKS:4,BGNODES:5,LINKS:6,NODES:7,DRAGGERS:8,BUBBLES:9,OVERLAYS:10,TOUCHES:11,OVERVIEW:12,WAIT:13};a.bgLayers=[c.BGSHAPES,c.BGLINKS,c.BGNODES],a.overviewLayers=[c.BGSHAPES,c.BGLINKS,c.BGNODES,c.SHAPES,c.LINKS,c.NODES,c.BUBBLES,c.OVERLAYS],a.topLayers=[c.SHAPES,c.LINKS,c.NODES,c.HANDLES,c.DRAGGERS,c.BUBBLES,c.OVERLAYS],a.hitLayers=[c.SHAPES,c.LINKS,c.NODES,c.HANDLES,c.BUBBLES,c.OVERLAYS,c.OVERVIEW],a.instructionPool=function(){return d()};var e=a.primitives={circle:"C",arc:"A",line:"L",text:"T",image:"I",rect:"R",round:"RR",triangle:"TR",path:"P"},f=a.colours={aqua:"rgb(0, 255, 255)",black:"rgb(0, 0, 0)",blue:"rgb(0, 0, 255)",fuchsia:"rgb(255, 0, 255)",green:"rgb(0, 128, 0)",grey:"rgb(128, 128, 128)",lime:"rgb(0, 255, 0)",maroon:"rgb(128, 0, 0)",navy:"rgb(0, 0, 128)",olive:"rgb(128, 128, 0)",purple:"rgb(128, 0, 128)",red:"rgb(255, 0, 0)",silver:"rgb(192, 192, 192)",teal:"rgb(0, 128, 128)",yellow:"rgb(255, 255, 0)",white:"rgb(255, 255, 255)",ci:"rgb(0, 174, 239)",cia:"rgba(0, 174, 239, 0.5)",keyline:"rgb(88, 89, 91)",midgrey:"rgb(145, 146, 149)",lightgrey:"rgb(208, 209, 211)",edit:"rgb(114, 179, 0)",attention:"rgb(220, 0, 0)",information:"rgb(0, 150, 255)",description:"rgb(255, 175, 0)",textback:"rgba(255,255,255,0.6)",transparent:"rgba(255,255,255,0.0)",touch:"rgba(255,0,0,0.6)"},g=a.rgbtostring=function(a,b,c){return"rgb("+a+","+b+","+c+")"},h=a.rgbatostring=function(a,b,c,d){return"rgba("+a+","+b+","+c+","+d+")"},i=/^(?:rgb)?\((0|[1-9]\d{0,2}),\s?(0|[1-9]\d{0,2}),\s?(0|[1-9]\d{0,2})\s?\)$/i,j=/^(?:rgba)?\((0|[1-9]\d{0,2}),\s?(0|[1-9]\d{0,2}),\s?(0|[1-9]\d{0,2}),\s?(0|1|0\.\d{0,10})\)$/i,k=/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i,l=/^#([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])$/i,m=a.convertrgb=function(a){var b,c=[],d=f[a.toLowerCase()];a=d?d:a;var e=a.match(i);e||(e=a.match(j));if(e)for(b=1;b<4;b++)c.push(parseInt(e[b],10));else{e=a.match(l);if(!e){e=a.match(k);if(e)for(b=1;b<4;b++)e[b]=""+e[b]+e[b]}if(e)for(b=1;b<4;b++)c.push(parseInt(e[b],16))}return c},n=a.opacity=function(a){var b=a.match(j);return b?parseFloat(b[4]):1};a.hsla=function(a){var b=m(a),c=S(b[0],b[1],b[2]);return c.push(n(a)),c},a.fromhsla=function(a){var b=U(a[0],a[1],a[2]);return h(b[0],b[1],b[2],a[3])};var o=a.rgbtohex=function(a){var b=m(a),c="";for(var d=0;d<b.length;d++){var e=b[d];c+=(e<16?"0":"")+e.toString(16)}return c},p=a.randomColour=function(a){function b(){return Math.floor(Math.random()*255)}var c=g(b(),b(),b());return a&&c in a?p(a):c},q={};a.clearLastFont=function(){q={}};var r="Ubuntu",s=a.setFont=function(a,b,c,d){c=c?!0:!1,d=d?d:r;if(a===q.context&&b===q.fontSize&&c===q.bold&&d===q.family)return;q.context=a,q.fontSize=b,q.bold=c,q.family=d;var e=c?"bold":"normal",f="normal",g="px",h=f+" "+e+" "+b+g+" "+d;a.font=h,a.textAlign="left",a.textBaseline="bottom"};a.test_instructions=[{p:e.circle,x:100,y:100,r:50,bc:f.red,bw:4,fc:f.blue,fi:!0},{p:e.line,x1:200,y1:200,x2:300,y2:300,c:f.green,w:3},{p:e.text,x:400,y:450,t:"Cambridge Intelligence",c:f.grey,fs:16},{p:e.rect,x1:200,y1:50,x2:300,y2:80,bc:f.red,bw:4,fc:f.blue,fi:!0},{p:e.round,x1:400,y1:50,x2:500,y2:80,r:10,bc:f.red,bw:4,fc:f.blue,fi:!0},{p:e.image,x1:300,y1:100,x2:556,y2:256,u:"icon/identity.png"},{p:e.image,x1:50,y1:300,x2:206,y2:556,u:"icon/laptop.png"}];var t=a.setAlpha=function(a,b){var c=["c","fc","bc"];for(var d=0;d<c.length;d++){var e=c[d];if(e in a){var f=m(a[e]);a[e]=h(f[0],f[1],f[2],b)}}},u=a.alphaize=function(a,b){var c=m(a),d=n(a);return h(c[0],c[1],c[2],d*b)},v=a.setExtents=function(b,c,d,e,f,g){var h,i;switch(b.p){case a.primitives.circle:h=Math.abs((e-c)/2),i=Math.abs((f-d)/2),b.x=Math.floor(Math.min(c,e)+h),b.y=Math.floor(Math.min(d,f)+i),b.r=Math.floor(Math.min(h,i));break;case a.primitives.line:case a.primitives.rect:case a.primitives.round:b.x1=Math.min(c,e),b.x2=Math.max(c,e),b.y1=Math.min(d,f),b.y2=Math.max(d,f);break;case a.primitives.text:b.x=Math.min(c,e),b.y=Math.max(d,f);break;case a.primitives.image:b.x1=Math.min(c,e),b.y1=Math.min(d,f),b.x2=Math.max(c,e),b.y2=Math.max(d,f);break;case a.primitives.triangle:}},w=a.extents=function(b,c){var d,e,f,g;switch(c.p){case a.primitives.circle:d=c.x-c.r,e=c.x+c.r,f=c.y-c.r,g=c.y+c.r;break;case a.primitives.line:case a.primitives.rect:case a.primitives.round:case a.primitives.image:d=Math.min(c.x1,c.x2),e=Math.max(c.x1,c.x2),f=Math.min(c.y1,c.y2),g=Math.max(c.y1,c.y2);break;case a.primitives.text:var h=G(b,c.t,c.fs,c.bo,c.ff);d=c.x,f=c.y-h.height,e=c.x+h.width,g=c.y;break;case a.primitives.triangle:d=Math.min(c.x1,c.x2,c.x3),e=Math.max(c.x1,c.x2,c.x3),f=Math.min(c.y1,c.y2,c.y3),g=Math.max(c.y1,c.y2,c.y3);break;case a.primitives.arc:var i=c.x+c.r*Math.cos(c.sa),j=c.y+c.r*Math.sin(c.sa),k=c.x+c.r*Math.cos(c.ea),l=c.y+c.r*Math.sin(c.ea);d=Math.min(i,k),e=Math.max(i,k),f=Math.min(j,l),g=Math.max(j,l);var m=(Math.floor(c.sa/(Math.PI/2))+1)*Math.PI/2;while(m<c.ea){var n=c.x+c.r*Math.cos(m),o=c.y+c.r*Math.sin(m);d=Math.min(d,n),e=Math.max(e,n),f=Math.min(f,o),g=Math.max(g,o),m+=Math.PI/2}}return{x1:d,y1:f,x2:e,y2:g}},x=a.join=function(a,b){return{x1:Math.min(a.x1,b.x1),y1:Math.min(a.y1,b.y1),x2:Math.max(a.x2,b.x2),y2:Math.max(a.y2,b.y2)}};a.inside=function(a,b,c){return a.x1<=b&&b<=a.x2&&a.y1<=c&&c<=a.y2},a.insideCircle=function(a,b,c,d,e,f){f||(f=0);var g=Math.sqrt((a-d)*(a-d)+(b-e)*(b-e));return g+f<c},a.rectContains=function(a,b,c,d,e){return a.x1<b&&d<a.x2&&a.y1<c&&e<a.y2},a.circleContains=function(a,b,c,d,e,f,g){var h=(a-d)*(a-d)+(b-e)*(b-e),i=(a-d)*(a-d)+(b-g)*(b-g),j=(a-f)*(a-f)+(b-e)*(b-e),k=(a-f)*(a-f)+(b-g)*(b-g),l=c*c;return h<l&&i<l&&j<l&&k<l},a.intersects=function(a,b){return!(b.x1>a.x2||b.x2<a.x1||b.y1>a.y2||b.y2<a.y1)};var y=function(a){switch(a.length){case 0:return undefined;case 1:return a[0];default:var b=a[0];for(var c=1;c<a.length;c++)b=x(b,a[c]);return b}},z=function(a,b,c,d,e,f){var g=[],h=Math.floor((b.x2-b.x1)/2),i=Math.floor((b.y2-b.y1)/2),j=1,k="-resize",l=Math.floor(4*c);B(a,{x:b.x1,y:b.y1},l,j,d+f+"nw"+k,e),A(a,{x:b.x1+h,y:b.y1},l,j,d+f+"n"+k,e),B(a,{x:b.x2,y:b.y1},l,j,d+f+"ne"+k,e),A(a,{x:b.x2,y:b.y1+i},l,j,d+f+"e"+k,e),B(a,{x:b.x2,y:b.y2},l,j,d+f+"se"+k,e),A(a,{x:b.x2-h,y:b.y2},l,j,d+f+"s"+k,e),B(a,{x:b.x1,y:b.y2},l,j,d+f+"sw"+k,e),A(a,{x:b.x1,y:b.y2-i},l,j,d+f+"w"+k,e)},A=function(a,b,c,d,e,g){a.rect(b.x-c,b.y-c,b.x+c,b.y+c,g,d,f.white,!0,e)},B=function(a,b,c,d,e,g){a.circle(b.x,b.y,c+1,g,d,f.white,!0,e)};a.getHandles=function(a,b,c,d,e,f,g){var h=w(b,c);z(a,h,d,e,f,g)};var C=a.getUnionExtents3=function(a,b){function d(b){c.push(w(a,b))}var c=[];return b.each(d),y(c)},D=a.images=function(b){function d(b){b.p===a.primitives.image&&(c[b.u]={})}var c={};return b.each(d),c},E=a.imageLoader=function(a,b,c,d){function i(){if(e+f===g)try{d(f>0,h)}catch(a){d("callback to image loader threw exception "+a)}}function j(a){f++,i()}function k(a){e++,i()}var e=0,f=0,g=0,h={};for(var l in c){g++;var m=a();m.onload=k,m.onerror=j,h[l]=m}g===0&&d(null,h);for(var n in h)h[n].src=b+n},F=a.draw6=function(a,b,c,d){function e(b){H(a,c,b)}b.each(e,d)};a.clear=function(a){a.clearRect(0,0,a.canvas.width,a.canvas.height)},a.backFill=function(a,b){a.fillStyle=b,a.fillRect(0,0,a.canvas.width,a.canvas.height)},a.backgroundGradient=function(a,b){if(b)if(a.hasOwnProperty("doGradient"))a.doGradient(Math.PI/2,b);else{var c=a.createLinearGradient(0,0,0,a.canvas.height);for(var d=0;d<b.length;d++)c.addColorStop(b[d].r,b[d].c);a.fillStyle=c,a.fillRect(0,0,a.canvas.width,a.canvas.height)}};var G=a.measureText=function(a,b,c,d,e){s(a,c,d,e);var f=a.measureText(b).width,g=c;return{width:f,height:g}};a.circularize=function(a,b,c){var d=!1,e={},g;try{for(g in a)if(g in b&&b[g]){var h=a[g].im,i=Math.min(h.width,h.height),j=i<h.height?Math.floor((h.height-i)/2):0,k=i<h.width?Math.floor((h.width-i)/2):0,l=Math.floor(i/2),m=c(i,i),n=m.getContext("2d");n.clearRect(0,0,i,i),n.drawImage(h,k,j,i,i,0,0,i,i);var o=c(i,i),p=o.getContext("2d");p.clearRect(0,0,i,i),J(p,l,l,l,f.white,-1,f.black,!0);var q=p.getImageData(0,0,i,i).data,r=n.getImageData(0,0,i,i),s=r.data;for(var t=0;t<s.length;t+=4)q[t+3]!==255&&(s[t+3]=q[t+3]);n.clearRect(0,0,i,i),n.putImageData(r,0,0),m.src=h.src+"#ci",e[g]=m}}catch(u){d=!0}for(g in e)a[g].ci=d?a[g].im:e[g]},a.colorize=function(a,b,c,d,e){var f=.02,g=m(d),h=S(g[0],g[1],g[2]),i={},j=m(e),k=S(j[0],j[1],j[2]),l=U(k[0],k[1],h[2]);for(var n in a)if(n in b&&b[n]){var o=a[n].im,p=c(o.width,o.height),q=p.getContext("2d");q.clearRect(0,0,o.width,o.height),q.drawImage(o,0,0,o.width,o.height,0,0,o.width,o.height);var r=q.getImageData(0,0,o.width,o.height),s=r.data;for(var t=0;t<s.length;t+=4){var u=S(s[t],s[t+1],s[t+2]);if(Math.abs(u[0]-h[0])<f){var v=U(k[0],k[1],u[2]);r.data[t]=v[0],r.data[t+1]=v[1],r.data[t+2]=v[2]}}q.clearRect(0,0,o.width,o.height),q.putImageData(r,0,0),p.src=o.src+e,i[n]=p}return{images:i,colour:l}},a.drawShadowCanvas=function(b,c,d,e,f,g,h){function n(b){var c=g.getColour(b.id);if(b.p===a.primitives.image)if(f)b.p=a.primitives.rect,b.fi=!0,b.fc=c,b.bc=c,b.bw=1;else{var e=b.u+c;j[e]=V(i[b.u],c,d),b.u=e}for(l=0;l<k.length;l++)b[k[l]]&&(b[k[l]]+=7);b.p===a.primitives.text&&(b.p=""),h&&h[b.id]&&(b.p="");for(l=0;l<m.length;l++)b[m[l]]&&(b[m[l]]=c)}var i;f||(i=R(e,d));var j={},k=["bw","w"],l,m=["c","fc","bc"];c.each(n),F(b,c,j)}})();


(function(){function c(){return{doSelection:function(a){},isSelected:function(a){return!1},setSelection:function(a,b,c){},moveSelection:function(a,b){},hasSelection:function(){return!1},selectAll:function(){},deleteSelection:function(){},createDragger:function(a,b,c,d,e,f,g,h){return null},createGestureDragger:function(a,b,c){return null},getByID:function(a){},setItem:function(a){},removeItem:function(a){},setProperties:function(a,b){},labelPosition:function(a,b){},hide:function(a){},hidden:function(){},show:function(a,b){},ghost:function(a){},resurrect:function(a,b){},makeAnimator:function(a,b){},applyVertices:function(a){},layout:function(a,b,c,d){},hierarchy:function(a,b,c,d){},merge:function(a){},serialize:function(a){},imageList:function(){return[]},interactionOptions:function(a){return{}},animated:function(){},editColour:function(a){},getCursor:function(a){},getResizePrimitive:function(){}}}function d(){function d(a){var b=0;while(c[b].max<a)b++;return c[b]}function e(c,d,e,f,g,i,j,k,l,m){var n=[],o=[],p=e;while(p<=f)n.push(p),o.push(h(p,g,i,j)),p=a.add(p,m.units,m.by);var q=b.colours.grey;for(var r=0;r<n.length;r++){var s=o[r];c.line(s,k-l,s,k,q,1,"_tick"+r);if(r<n.length-1){var u=a.format(n[r],m.f),v=b.measureText(d,u,10,!1).width,w=m.left?o[r]+3:Math.floor((o[r+1]+o[r])/2-v/2);c.text(w,k,u,q,10,!1,"_tick"+r)}}}function f(c,f,i,j,k,l,m,n){if(m===n)return;if(k===l)return;var o=g(k,l,m,n),p=2/3,q=p*o*(l-k),r=a.add(m,a.units.milli,-q),s=a.add(n,a.units.milli,q),u=g(k,l,r,s),v=d(u),w=[],x=[],y=a.add(r,a.units.milli,-q/2),z=a.add(s,a.units.milli,q/2),A=a.clear(y,v.clear.units,v.clear.by);e(c,f,A,z,k,r,u,i-10,13,v.major),v.minor&&e(c,f,A,z,k,r,u,i-23,10,v.minor);var B=i+j-10,C=3,D=h(m,k,r,u),E=h(n,k,r,u);c.rect(D,B+C,E,i+j,b.colours.cia,-1,b.colours.cia,!0,"_tbFill"),c.line(D,B+C,D,i+j,b.colours.ci,2,"_tbLeft"),c.line(E,B+C,E,i+j,b.colours.ci,2,"_tbRight")}function g(a,b,c,d){return(d.getTime()-c.getTime())/(b-a)}function h(a,b,c,d){return Math.floor(b+(a.getTime()-c.getTime())/d)}var a=typeof KeyLinesRequire!="undefined"?require("./datetime"):KeyLines.DateTime,b=typeof KeyLinesRequire!="undefined"?require("./rendering"):this.KeyLines.Rendering,c=[{max:2e7,clear:{units:a.units.month,by:1},major:{units:a.units.month,by:1,f:"MMMM yyyy"},minor:{units:a.units.week,by:1,f:"d",left:!0,clear:{units:a.units.week,by:1},add:function(b){var c=a.clone(b),d=c.getDate();c>=10&&c>=20&&c.setDate(0)}}},{max:3e7,clear:{units:a.units.month,by:3},major:{units:a.units.month,by:3,f:"Q  yyyy"},minor:{units:a.units.month,by:1,f:"MMMM"}},{max:5e7,clear:{units:a.units.month,by:3},major:{units:a.units.month,by:3,f:"Q  yyyy"},minor:{units:a.units.month,by:1,f:"MMM"}},{max:1e8,clear:{units:a.units.month,by:3},major:{units:a.units.month,by:3,f:"Q  yyyy"},minor:{units:a.units.month,by:1,f:"MMMMM"}},{max:2e8,clear:{units:a.units.month,by:6},major:{units:a.units.month,by:6,f:"QQ  yyyy"},minor:{units:a.units.month,by:1,f:"MMMMM"}},{max:45e7,clear:{units:a.units.year,by:1},major:{units:a.units.year,by:1,f:"yyyy"},minor:{units:a.units.month,by:3,f:"Q"}},{max:6e8,clear:{units:a.units.year,by:1},major:{units:a.units.year,by:1,f:"yyyy"},minor:{units:a.units.month,by:6,f:"QQ"}},{max:85e7,clear:{units:a.units.year,by:10},major:{units:a.units.year,by:10,f:"yyyy"},minor:{units:a.units.year,by:1,f:"'yy"}},{max:Infinity,clear:{units:a.units.year,by:10},major:{units:a.units.year,by:10,f:"yyyy"},minor:{units:a.units.year,by:1,f:"'yy"}}];return{instructions:f}}function e(a,b,c,d,e,f,g,h,i){function n(a,b){m.push(a),m.push(b)}function o(a,b){l.push(1),n(a,b)}function p(a,b){l.push(2),n(a,b)}function q(a,b,c,d){l.push(3),n(a,b),n(c,d)}var j=g/2,k="#asdfadsf",l=[],m=[];totalWidth=h+i;var r=(c+d)/2-totalWidth/2,s=1,t=Math.PI*0,u=h*Math.cos(t),v=h*(1-Math.sin(t)),w=v*Math.tan(t),x=i*Math.cos(t),y=i*(1-Math.sin(t)),z=y*Math.tan(t);o(c,f),p(r,f),q(r+(u-w)*s,f+v*(1-s),r+u,f+v),q(r+u+z*s,f+v+y*s,r+u+x,f+v+y),p(d,f+v+y),a.path(l,m,e,g,k)}function f(a,b,c,d){var f=a[0],h=a[a.length-1],i;if(b){var j=g(h.w),k=g(f.w);i=j+k+(h.y-f.y);for(var l=0;l<a.length;l++){var m=a[l];e(c,d,100,600,m.c,m.y,m.w,j+h.y-m.y,k+m.y-f.y)}}return i}function g(a){return Math.max(2*a,30)}function h(){return{instructions:function(a,b,c,d,e){bands=[{y:240,w:Math.floor(c.w(14)/2)*2,c:"rgb(91,92,95)"},{y:260,w:Math.floor(c.w(14)/2)*2,c:"rgb(41,92,95)"},{y:280,w:Math.floor(c.w(14)/2)*2,c:"rgb(91,42,95)"}];var g=f(bands,!0,a,c)}}}var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.TimeModel={});var b=typeof KeyLinesRequire!="undefined"?require("./util"):this.KeyLines.Util;a.createModel=function(a,b){function l(a){var b=i.getTime()-0+k*a,c=new Date;return c.setTime(b),c}var e=c(),f=d(),g=h();e.type=function(){return"Timeline"},e.load=function(a){};var i=new Date(2011,10,4),j=new Date(2012,1,1),k=(j.getTime()-i.getTime())/500;return e.generate=function(a,b,c,d,e,h){var i=c.newToOldX(0),j=c.newToOldX(c.width()),k=l(i),m=l(j);f.instructions(a,b,100,20,0,c.width(),k,m),g.instructions(a,b,c,d,e)},e}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Combo={}),a.create=function(a){function c(b,c){var d=[],e=a.serialize().items;for(var f=0;f<e.length;f++){var g=e[f];g.type===c&&b[g.id]&&d.push(g)}return d}function d(a){var b={};for(var c=0;c<a.length;c++)b[a[c].id]=a[c];return b}function e(a){var c=[];for(var d in a)d=b.ensureId(d),c.push(a[d]);return c}function f(a){return a+Math.floor(Math.random()*1e7)}function g(a,b){var c=f(b);return a[c]?g(a):c}function h(a,b){return a.substr(0,b.length)===b}function k(a){return h(a,i)}function l(a){var b=[];if(k(a)){var c=j[a].nodes;for(var d=0;d<c.length;d++)k(c[d].id)?b=b.concat(l(c[d].id)):b.push(c[d])}return b}function m(a){var b=[];if(k(a)){var c=j[a].nodes;for(var d=0;d<c.length;d++)k(c[d].id)&&(b.push(c[d].id),b=b.concat(m(c[d].id)))}return b}function n(a,b){var c=q[a.id];if(typeof c=="undefined")return 0;var d=j[c],e=Number(a[b])-Number(d[b]);return e+n(d,b)}function o(a,b,c){var d=g(j,i);return j[d]={id:d,nodes:a,x:b,y:c},d}function p(a){var b=j[a];return delete j[a],b}function r(){var a={};for(var c in j){c=b.ensureId(c);for(var d=0;d<j[c].nodes.length;d++)a[j[c].nodes[d].id]=c}return a}function s(){q=r()}function t(a){var b;while(a)b=a,a=q[a];return b}function u(a){return a!==t(a)}function w(a){return h(a,v)}function x(){var b=f(v);return a.getItem(b)?x():b}function z(a,b,c){var d=t(a.id1),e=t(a.id2);return d===b&&e===c||d===c&&e===b}function A(c){if(w(c)){var d=a.getItem(c);if(d){var e=[];for(var f in y)f=b.ensureId(f),z(y[f],d.id1,d.id2)&&e.push(y[f]);return e}}return null}function B(){function e(a,b,c){var e=a<b?a:b,f=a>b?a:b;d[e]||(d[e]={}),d[e][f]||(d[e][f]=[]),d[e][f].push(c)}function f(a){for(var b=0;b<a.length;b++)if(!a[b].hi)return!0;return!1}var c={};a.privateEach({type:"node"},function(a){c[a.id]={}}),a.privateEach({type:"link"},function(a){c[a.id1][a.id2]=c[a.id2][a.id1]=!0});var d={};for(var g in y){g=b.ensureId(g);var h=y[g],i=t(h.id1),j=t(h.id2);i!==j&&(c[i][j]||e(i,j,h))}var l=[];for(var m in d){m=b.ensureId(m);for(var n in d[m]){n=b.ensureId(n);if(k(m)||k(n)){var o=d[m][n],p=b.clone(o[0]);p.id1=m,p.id2=n,p.id=x(),p.hi&&f(o)&&delete p.hi,p.off=undefined,l.push(p)}else{var q=d[m][n];for(var r=0;r<q.length;r++)l.push(q[r]),delete y[q[r].id]}}}return l}function C(a,c){if(!b.isNullOrUndefined(c.label))return c.label;var d="";for(var e=0;e<a.length;e++)b.isNullOrUndefined(a[e].t)||(d+=a[e].t,e<a.length-1&&(d+="\n"));return d}function D(a,b,c,d){var e,f=0,g=0;for(e=0;e<a.length;e++)f+=a[e].x,g+=a[e].y;f/=a.length,g/=a.length;var h=b.position==="average"?f:a[0].x,i=b.position==="average"?g:a[0].y;for(e=0;e<a.length;e++)c.push({id:a[e].id,x:h,y:i}),e>0&&d.push({id:a[e].id,x:a[e].x+b.dx,y:a[e].y+b.dy});return{x:h,y:i}}function E(a,c,d){var e=c.style?c.style:b.clone(a[0]);delete e.id,b.isNormalObject(c.style)&&(e=b.merge(e,c.style));var f={p:"ne",c:"rgb(255, 0, 0)",t:d};b.isNormalObject(c.glyph)&&(c.glyph=b.defaults(c.glyph,{p:"ne",c:null,u:null})),b.isNormalObject(c.glyph)&&(f=b.merge(f,c.glyph),!c.glyph.c&&!c.glyph.u&&(f.c="rgb(255, 0, 0)"));var g=[];return c.glyph!==null&&g.push(f),e.g=g,b.isNormalObject(c.d)&&(e.d=b.clone(c.d)),e.type="node",e}function F(a){var b=[];for(var c=0;c<a.length;c++)b.push(a[c].id);return b}function G(a){var b=[],c={},d;for(var e=0;e<a.length;e++)for(var f=0;f<a[e].ids.length;f++){d=a[e].ids[f];if(!c[d])c[d]=1,b.push(d);else throw new Error("[Combine] nodes should be only in one combo")}return b}function H(b){var c,d,e={},f=[];for(var g=0;g<b.length;g++){c=b[g];if(!e[c]){d=a.getItem(c);if(!d||d.type!=="node")throw new Error("[Combine] function must be passed valid ids");d.type==="node"&&(f.push(d),e[c]=1)}}if(f.length<2)throw new Error("[Combine] function must be passed more than one node id");return f}function I(a,c,d){var e=o(a,d.x,d.y);s();var f=l(e),g=E(a,c,f.length),h=b.merge(g,{id:e,t:C(a,c),x:d.x,y:d.y});return h}function J(c,d,e){function r(){var f=[];for(var g=0;g<c.length;g++){var h=I(j[g],c[g],n[g]);f.push(h)}a.merge(f,function(){a.privateRemoveItem(k);var c=B();a.privateMerge(c,function(){var c=F(f);d.select&&(a.selection(c),a.trigger("selectionchange")),b.invoke(e,c)})})}var f,g,h,i,j=[];d=b.defaults(d,{animate:!0,select:!0,time:250}),c=b.ensureArray(c);for(f=0;f<c.length;f++)i=c[f],c[f]=b.defaults(i,{position:"average",dx:0,dy:0,label:null,style:null,d:null}),c[f].ids=b.ensureArray(c[f].ids),h=H(c[f].ids),j.push(h);var k;k=G(c);var l=[],m=[],n=[],o;for(f=0;f<c.length;f++)o=D(j[f],c[f],l,m),n.push(o);var p=a.graph().neighbours(k,{all:!0});for(g=0;g<p.links.length;g++){var q=p.links[g];w(q)||(y[q]=a.getItem(q))}a.trigger("prechange","combine");var s=l.length?d.time:0;a.setProperties(m,!1,function(){d.animate?a.animateProperties(l,{time:s},r):a.setProperties(l,!1,r)})}function K(b){for(var c=0;c<b.length;c++){var d=b[c];d.hi=!a.privateBothEndsShown(d)}}function L(c,d,e){function D(){d.select&&(a.selection(r),a.trigger("selectionchange")),b.invoke(e)}a.trigger("prechange","uncombine"),d=b.defaults(d,{animate:!0,time:250,full:!1,select:!0}),s();var f=b.ensureArray(c),g={},h,i=0,o={},q=[],r=[],t=[];for(var u=0;u<f.length;u++){h=f[u];if(k(h)){var v=a.getItem(h);v&&(i++,g[h]=a.getItem(h),d.full?(o[h]=l(h),q=q.concat(m(h))):o[h]=j[h].nodes)}}if(i===0){b.invoke(e);return}for(h in g){h=b.ensureId(h);for(var w=0;w<o[h].length;w++){var x=o[h][w];r.push(x.id),t.push({id:x.id,x:g[h].x+n(x,"x"),y:g[h].y+n(x,"y")})}}for(var y=0;y<q.length;y++)p(q[y]);for(h in g){h=b.ensureId(h);var z=o[h];for(var A=0;A<z.length;A++)z[A].x=g[h].x,z[A].y=g[h].y,a.setItem(z[A]);p(h),a.privateRemoveItem(h)}s();var C=B();K(C),a.privateMerge(C,function(){d.animate?a.animateProperties(t,{time:d.time},D):a.setProperties(t,!1,D)})}function M(a){return k(a)?{nodes:l(a),links:null}:w(a)?{nodes:null,links:A(a)}:null}function N(a){a&&(j=d(a.nodes),y=d(a.links));var c=b.clone(e(j)),f=b.clone(e(y));return{nodes:c,links:f}}var b=typeof KeyLinesRequire!="undefined"?require("./util"):KeyLines.Util,i="_combo_",j={},q={},v="_combolink_",y={},O={api:{combine:J,uncombine:L,info:M,isCombo:function(a,c){var d=b.ensureArray(a);c=b.defaults(c,{type:"all"});if(!c.type.match(/^(node|link|all)$/))throw new TypeError("opts type property should be either 'node', 'link' or 'all'");for(var e=0;e<d.length;e++){if(k(d[e])&&c.type!=="link")return!0;if(w(d[e])&&c.type!=="node")return!0}return!1}},internalUse:{preMerge:function(a){var b=[];for(var c=0;c<a.length;c++){var d=a[c];d.type==="node"&&(u(d.id)||b.push(d)),d.type==="link"&&(u(d.id1)||u(d.id2)?y[d.id]=d:b.push(d))}return b},postMerge:function(b){var c=B();a.privateMerge(c,b)},preDelete:function(d){d=b.ensureArray(d);var e=b.makeIdMap(d),f=c(e,"node"),g=[];for(var h=0;h<f.length;h++)g.push(f[h].id);var i=c(e,"link"),j=a.graph().neighbours(g,{all:!0}).links,l=b.makeIdMap(j);for(var m=0;m<i.length;m++)l[i[m].id]=1;for(var n in l){n=b.ensureId(n);if(w(n)){var o=A(n);for(var q=0;q<o.length;q++)y[o[q].id]&&delete y[o[q].id]}}for(var r=0;r<f.length;r++){var t=f[r].id;k(t)&&p(t)}s()},serialize:N,loadUp:function(a){a?N(a):(j={},y={}),s()}}};return O}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Overlays={});var b=typeof KeyLinesRequire!="undefined"?require("./rendering"):this.KeyLines.Rendering;a.createOverlays=function(a,c){function j(a,b){return i[a]=b?!0:!1,a}function m(){k=b.colours.ci,l=b.colours.cia}function n(a){h[a]&&h[a].apply(null,arguments)}function p(a,c,d,e,f,g,h){a.rect(c.scale(d),c.scale(e),c.scale(f),c.scale(g),b.colours.white,-1,b.colours.white,!0,h)}var d={},e={},f={},g=[],h={},i={};d.appendImageList=function(a){for(var b in i)a[b]=1};var k,l;m(),d.colorize=function(a,c,d){var e={},f,g="rgb(0,174, 234)";if(d){var h=b.colorize(a,i,c,g,d);f=h.colour,e=h.images,k=b.rgbtostring(f[0],f[1],f[2]),l=b.rgbatostring(f[0],f[1],f[2],.5)}else m();for(var j in a){var n=e[j]?e[j]:a[j].im;a[j].co=n}},d.setup=function(){o(),a.bind("click",n)},d.createDragger=function(a,b,c){return a in e?e[a](b,c):null};var o=d.reset=function(){e={},f={},g=[],h={},i={},a.unbind("click",n),wmWidth=undefined,wmHeight=undefined};d.getCursor=function(a){return a in f?f[a]:"auto"},d.generate=function(a,b,c,d,e,f,h,i){for(var j=0;j<g.length;j++)g[j].generate(a,b,c,d,e,f,h,i)},d.getWatermarkSize=function(a,b){for(var c=0;c<g.length;c++){var d=g[c];if(d.watermarkSize)return d.watermarkSize(a,b)}return null},d.addTimebar=function(a,b,c,d,e){var f="_timeBar",g={}},d.addLogo=function(a,c){var d=15,e="_logo",f={generate:function(c,f,g,h,i,j,k){c.layer(b.layers.OVERLAYS);var l=h[a].im;j||c.image(g.scale(g.width()-(l.width+d)),g.scale(d),g.scale(g.width()-d),g.scale(d+l.height),a,e)}};g.push(f),j(a)},d.remove=function(a,c,d){var e=42,f={generate:function(f,g,h,i,j,k,l){f.layer(b.layers.OVERLAYS);if(!k){var m=b.measureText(g,a,e).width,n=h.scale((h.width()-m)/2),o=h.scale((h.height()+e)/2);f.text(n+2,o+2,a,d,h.scale(e),!0,""),f.text(n,o,a,c,h.scale(e),!0,"")}}};g.push(f)},d.addTextWatermark=function(a,c,d,e,f,h,i,k){var l="_textWatermark",m={watermarkSize:function(e,f){var g,h;if(a&&f){var i=f[a].im;g=i.width,h=i.height}else c&&(g=b.measureText(e,c,d,k).width,h=d);return g?{width:g+10,height:h+10}:null},generate:function(g,j,m,n,o,p,q){g.layer(b.layers.UNDERLAYS);if(!p){if(a){var r=n[a].im;x=m.scale((m.width()-r.width)/2),y=m.scale((m.height()-r.height)/2),g.image(x,y,x+m.scale(r.width),y+m.scale(r.height),a,l);return}if(c){var s=m.scale(d),t=b.measureText(j,c,d,k).width;x=m.scale((m.width()-t)/2),y=m.scale((m.height()+d)/2);var u=Math.floor(s/4),v=Math.floor(s/8);i==="top"&&(y=s+v),i==="bottom"&&(y=m.scale(m.height())+1),h&&g.rect(x-u,y-s-v,x+t+u+v,y,h,-1,h,!0,l),g.text(x,y,c,e,s,f,l,k)}}}};g.push(m),a&&j(a)},d.addNavigation=function(c,d,i,k,l,m){function A(){return c.interactionOptions().handMode}function B(a,b){var d=a-z[q].im.height/2,e=D(d);c.setZoom(e,b)}function C(a){var b=(Math.log(a)-Math.log(k.minZoom()))/(Math.log(k.maxZoom())-Math.log(k.minZoom()));return Math.floor(x+(1-b)*(y-x))}function D(a){var b=1-(a-x)/(y-x),c=Math.exp(b*(Math.log(k.maxZoom())-Math.log(k.minZoom()))+Math.log(k.minZoom()));return c}function E(){return k.height()<300}var n=j(m+"Background.png",!0),o=j(m+"BackgroundShort.png",!0),q=j(m+"Slider.png"),r=j(m+"Hand.png"),s=j(m+"Arrow.png"),t={},u=7,v=17,w=28,x=135,y=232,z;h._zoomIn=function(){c.zoomIn(!0)},h._zoomOut=function(){c.zoomOut(!0)},h._panLeft=function(){c.panLeft(!0)},h._panRight=function(){c.panRight(!0)},h._panUp=function(){c.panUp(!0)},h._panDown=function(){c.panDown(!0)},h._fitToWindow=function(){c.fitToModel(!0)},h._toggleMode=function(){var a=c.interactionOptions();a.handMode=!a.handMode,c.interactionOptions(a)},h._scale=function(a,b,c){B(c,!0)},f._zoomIn=f._zoomOut=f._panLeft=f._panRight=f._panUp=f._panDown=f._fitToWindow=f._toggleMode=f._scale="pointer",f._slider='url("'+m+'openhand.cur"), pointer',e._slider=function(){var b=k.zoom();if(E())return null;if(a.trigger("dragstart","slider"))return;return{getCursor:function(a,b){return"move"},dragMove:function(a,b,c,d){b=k.unscale(b),B(b,!1)},endDrag:function(d,e,f,g,h){var i=a.trigger("dragend","slider");d=d&&!i,d||c.setZoom(b,!1),a.trigger("dragcomplete","slider")}}};var F={generate:function(a,c,d,e,f,g,h){a.layer(b.layers.OVERLAYS);var i=E()?o:n,j=e[i].im;if(!h){z=e;if(!g)a.image(d.scale(u),d.scale(v),d.scale(u+j.width),d.scale(v+j.height),i,"_background","co"),a.image(d.scale(26),d.scale(81),d.scale(54),d.scale(113),A()?r:s,"_toggleMode");else{var k=18;p(a,d,32,104+k,54,115+k,"_zoomIn");var l=E()?125:223;p(a,d,32,l+k,54,l+17+k,"_zoomOut"),p(a,d,16,42,32,58,"_panLeft"),p(a,d,53,42,68,58,"_panRight"),p(a,d,32,25,48,41,"_panUp"),p(a,d,32,63,48,76,"_panDown"),p(a,d,32,48,48,58,"_fitToWindow"),E()||p(a,d,36,119+k,50,220+k,"_scale"),p(a,d,27,85,49,107,"_toggleMode")}if(!E()){var m=C(d.zoom());a.image(d.scale(w),d.scale(m),d.scale(w+e[q].im.width),d.scale(m+e[q].im.height),q,"_slider")}}},createDragger:function(a,b,c,d,e){}};f[n]="wait",g.push(F)};var q,r,s;return d.addOverview=function(d,i,m,n,o,p,t,u){function C(a){var b={x1:m.newToOldX(m.scale(-a)),x2:m.newToOldX(m.scale(m.width()+a)),y1:m.newToOldY(m.scale(-a)),y2:m.newToOldY(m.scale(m.height()+a))};return{x1:B.oldToNewX(b.x1),x2:B.oldToNewX(b.x2),y1:B.oldToNewY(b.y1),y2:B.oldToNewY(b.y2)}}function L(){H+=J.x,I+=J.y,a.trigger("redraw")}function N(){M=setInterval(L,50)}function O(){M&&(clearInterval(M),M=null)}var v=j(o+"ArrowUp.png",!0),w=j(o+"ArrowDown.png",!0);u=u||100,q=u,s=t,r=n(u,u);var x=r.getContext("2d"),y=!1,z=!1,A=(new Date).getTime(),B=c.createView(a,u,u);h._overviewIcon=function(){s=!s,a.trigger("overview",s?"open":"close")},f._overviewIcon="pointer";var D=null,E=!1,F=0,G=0,H=0,I=0,J,K=2;f._overviewBox='url("'+o+'openhand.cur"), pointer';var M;e._overviewBox=function(b,c){if(a.trigger("dragstart","overview"))return;E=!0;var e=2;F=0,G=0,H=0,I=0;var f=-D.x1+e,g=u-D.x2-e,h=-D.y1+e,i=u-D.y2-e;return{getCursor:function(a,b){return"move"},dragMove:function(a,d,e,j){O(),F=a-b,G=d-c,J={x:0,y:0};var k=!1;F<f&&(F=f,J.x=K,k=!0),F>g&&(F=g,J.x=-K,k=!0),G<h&&(G=h,J.y=K,k=!0),G>i&&(G=i,J.y=-K,k=!0),k&&N()},endDrag:function(b,c,e,f,g){E=!1,O();var h=a.trigger("dragend","overview");if(b&&!h){var i=-(F-H)*m.zoom()/B.zoom(),j=-(G-I)*m.zoom()/B.zoom();d.panBy(i,j,!0)}a.trigger("dragcomplete","overview")}}};var P=b.instructionPool(),Q={generate:function(c,e,f,g,h,j,m,n){c.layer(b.layers.OVERVIEW);if(!m){if(s){c.rect(f.scale(f.width()-u-2),f.scale(f.height()-u-2),f.scale(f.width()+1),f.scale(f.height()+1),b.colours.white,Math.max(1,f.scale(3)),b.colours.white,j,"_overviewBorder1"),c.rect(f.scale(f.width()-u)-.5,f.scale(f.height()-u)-.5,f.scale(f.width()+1),f.scale(f.height()+1),b.colours.lightgrey,Math.max(1,f.scale(1)),b.colours.white,!1,"_overviewBorder2");if(i&&!j){var o=(new Date).getTime();if(y&&!E&&o<A+1e3&&z)a.trigger("redraw");else{A=(new Date).getTime(),y=!0,x.clearRect(0,0,u,u),x.fillStyle=b.colours.white,x.fillRect(0,0,u,u),d.drawBackground(x);var q=Math.max(f.width(),f.height())/2;B.reset(!1,!0);var r=C(q);B.fitExtents(r,!1,!1,undefined,undefined,undefined,!0);var t=f.getMaxItemZoom();t!==Infinity&&B.setMaxItemZoom(t/8),E&&B.panBy(H,I,!1,!0),P.reset(),i.generate(P,x,B,g,null,null,n),b.draw6(x,P,g,b.overviewLayers),z=(new Date).getTime()-A>30}}i&&(D||(D=C(0)),c.layer(b.layers.OVERVIEW),E||c.rect(f.scale(f.width()-u+D.x1),f.scale(f.height()-u+D.y1),f.scale(f.width()-u+D.x2),f.scale(f.height()-u+D.y2),k,Math.max(1,f.scale(2)),l,!0,"_overviewBox"),E&&c.rect(f.scale(f.width()-u+D.x1+F),f.scale(f.height()-u+D.y1+G),f.scale(f.width()-u+D.x2+F),f.scale(f.height()-u+D.y2+G),k,Math.max(1,f.scale(2)),b.colours.white,!1,"_overviewBoxDragging"))}var J=s?w:v,K=g[J].im;p&&(j?c.rect(f.scale(f.width()-K.width*2),f.scale(f.height()-K.height*2),f.scale(f.width()+1),f.scale(f.height()+1),b.colours.lightgrey,-1,b.colours.white,!0,"_overviewIcon"):(c.rect(f.scale(f.width()-K.width)-.5,f.scale(f.height()-K.height)-.5,f.scale(f.width()+1),f.scale(f.height()+1),b.colours.lightgrey,Math.max(1,f.scale(1)),b.colours.white,!0,"_overviewIconRect"),c.image(f.scale(f.width()-K.width),f.scale(f.height()-K.height),f.scale(f.width()),f.scale(f.height()),J,"_overviewIcon","co")))}}};g.push(Q)},d.drawOverviewContent=function(a,b){if(s&&r){var c=b.scale(q);a.isFlash?a.drawImageDirect(r,0,0,q,q,b.scale(b.width()-q),b.scale(b.height()-q),c,c):a.drawImage(r,0,0,c,c,b.scale(b.width()-q),b.scale(b.height()-q),c,c)}},d}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Graph={}),a.create=function(a,b){function z(a){a.direction=a.direction||"any";if(!a.direction.match(/^(any|from|to)$/))throw new TypeError("opts direction property should be either 'from', 'to' or 'any'")}function A(a){a.normalization=a.normalization||"any";if(!a.normalization.match(/^(chart|component|unnormalized)$/))throw new TypeError("opts normalization property should be either 'component', 'chart' or 'unnormalized'")}function B(a){return k(a,function(b,c,d,e){if(v(d,e,c,a)<=0)throw new Error("Link Weight must be Positive")}),{direction:a.direction,value:a.value,weights:F(a)}}function C(a){return a.normalization.match(/component/)?"component":a.normalization.match(/chart/)?"chart":"unnormalized"}function D(a){return z(a)||B(a)}function E(a){a.all=!!a.all}function F(a){return!!a.weights}function G(a){var b=0;return l(a,function(a,c){b++}),b}var c=typeof KeyLinesRequire!="undefined"?require("./util"):KeyLines.Util,d={},e={},f={},g=b;d.privateSetProperties=function(a,b){e=a,f=b};var h={},i=[],j={},k=function(a,b){var d=a.all;for(var e in f){e=c.ensureId(e);var g=f[e];(a.all||!g.hi)&&b(g,g.id,g.id1,g.id2)}},l=function(a,b){var d=a.all;for(var f in e){f=c.ensureId(f);var g=e[f];(a.all||!g.hi)&&b(g,g.id)}},m=function(a,b,c,d){function e(){var b=[];return l(a,function(a){b.push(a)}),b}var f=e(),h=f.length,i=-1,j=(new Date).getTime(),k=j,m=700,n=function(){i++;if(i<h)c(f[i],q);else{o(1),d();return}},o=function(a){g&&g.trigger("progress",b,a)},p=function(){return j=(new Date).getTime(),j-k>m?(k=(new Date).getTime(),!0):!1},q=function(){p()?(o(i/h),setTimeout(n,0)):n()};o(0),q()},n=function(a){var b=[],d={};k(a,function(a,b,c,e){var f=c<e?c:e,g=c<e?e:c;d[f]||(d[f]={}),d[f][g]||(d[f][g]=[]),d[f][g].push(a.id)});for(var e in d){e=c.ensureId(e);for(var f in d[e])f=c.ensureId(f),b.push(d[e][f])}return b};d.adjacent=function(a,b){return j[a]&&j[a][b]?j[a][b].length:0};var o=d.neighbours=function(a,b){var d=[],g={},h=c.makeIdMap(a);b=c.defaults(b,{all:!1}),E(b);for(var i in h){i=c.ensureId(i);if(!e[i]&&!f[i])throw new Error("neighbours error: ids must be present in the graph")}return k(b,function(a,b,c,e){h[c]&&(d.push(a.id),g[e]=1),h[e]&&(d.push(a.id),g[c]=1),h[a.id]&&(g[c]=1,g[e]=1)}),{nodes:c.flattenMap(g),links:d}},p=d.components=function(a){var b=[],d=0,e=[],f,g;a=c.defaults(a,{all:!1}),E(a),q(a);for(f in h)if(!h[f].hasOwnProperty("c")){b.push(f+"");while(b.length>0){var j=b.shift();if(!h[j].hasOwnProperty("c")){h[j].c=d;for(g=0;g<i.length;g++)i[g].id1===j&&(i[g].c=d,b.push(i[g].id2)),i[g].id2===j&&(i[g].c=d,b.push(i[g].id1))}}e.push({nodes:[],links:[]}),d++}for(f in h)e[h[f].c].nodes.push(f+"");for(g=0;g<i.length;g++)e[i[g].c].links=e[i[g].c].links.concat(i[g].ids);return e},q=d.reset=function(a){var b=n(a),c,d=0;h={},i=[],l(a,function(a,b){d++,h[b]={x:a.x,y:a.y},j[b]={}});for(var e=0;e<b.length;e++)c=f[b[e][0]],i.push({id:c.id,id1:c.id1,id2:c.id2,ids:b[e]}),c.id1!==c.id2&&(j[c.id1][c.id2]=j[c.id2][c.id1]=b[e])},r=d.shortestPaths=function(a,b,d){function j(a){var b=[];for(var c=0;c<a.length;c++)g[a[c].id]&&(b=b.concat(g[a[c].id]));return b}if(!e[a]||!e[b])throw new Error("shortestPaths error: ids must be present in the graph");d=c.defaults(d,{all:!1}),D(d),E(d);var f=y(a,d),g=f.previous;if(f.distance[b]===Infinity)return{one:[],items:[],distance:Infinity};var h=[],i=b;while(g[i])h.unshift(i),i=g[i][0].id;h.unshift(i);var k={};k[b]=1;var l=[];l.push({id:b});var m=j(l);while(m.length>0){for(var n=0;n<m.length;n++){k[m[n].id]=1;for(var o=0;o<m[n].links.length;o++)k[m[n].links[o]]=1}m=j(m)}return{one:h,items:c.flattenMap(k),distance:f.distance[b]}},s=d.distances=function(a,b){if(!e[a])throw new Error("distances error: id(s) must be present in the graph");b=b||{},D(b),E(b);var c=y(a,b),d={};for(var f in c.distance){var g=c.distance[f];isFinite(g)&&(d[f]=g)}return d},t=function(a,b,c){var d=j[a][b],e=Infinity,f=w(c),g;if(d)for(var h=0;h<d.length;h++){var i=f(a,b,d[h],c);isNaN(i)||(i<e&&(g=[],e=i),i===e&&e!==Infinity&&g.push(d[h]))}return{value:e,links:g}},u=function(a,b){return f[a].a2&&f[a].id2===b||f[a].a1&&f[a].id1===b},v=function(a,b,c,d){var e=NaN,g=!0;return d.direction!=="any"&&(g=d.direction==="from"&&u(c,b)||d.direction==="to"&&u(c,a)),g&&(d.value?f[c].d&&(e=Number(f[c].d[d.value])):e=1),e},w=function(a){return F(a)?x:v},x=function(a,b,c,d){var e=v(a,b,c,d);return isNaN(e)?e:1/e},y=function(a,b){function g(){var a,b=Infinity;for(var c=0;c<f.length;c++){var e=d[f[c]];e<=b&&(a=c,b=e)}return a}function h(a,b,c){e[a]||(e[a]=[]),e[a].push({id:b,links:c})}var d={},e={},f=[];q(b),l(b,function(a,b){d[b]=Infinity,e[b]=undefined,f.push(b)}),d[a]=0;while(f.length>0){var i=g(),k=f[i];if(d[k]===Infinity)break;f.splice(i,1);for(var m in j[k]){m=c.ensureId(m);var n=t(k,m,b),o=d[k]+n.value;o<d[m]?(d[m]=o,e[m]=[{id:k,links:n.links}]):o===d[m]&&h(m,k,n.links)}}return{distance:d,previous:e}},H=d.degrees=function(a){a=c.defaults(a,{multi:!0,all:!1}),D(a),E(a),q(a);var b={};return l(a,function(d,e){b[e]=0;for(var f in j[e]){f=c.ensureId(f);for(var g=0;g<j[e][f].length;g++){var h=v(e,f,j[e][f][g],a);if(!isNaN(h)){b[e]+=h;if(!a.multi)break}}}}),b},I=d.betweenness=function(a,b){function d(a,b){return K[a]-K[b]}function e(a){return a.sort(d),a.shift()}function f(a,b){a.sort(d);if(c.contains(a,b))return;a.push(b)}function g(a,b){var c=t(a,b,y).value;return isFinite(c)?c:!s()&&!isFinite(c)?1:Infinity}function h(a){return a.length>0}function i(){B.length=0,G.length=0,l(a,function(a,b){for(var c=0;c<T.length;c++)n(T[c].dict,b,T[c].value)})}function k(a,b,c){l(a,function(a,d){n(b,d,c)})}function n(a,b,d){c.isArray(d)&&h(d)&&a[b]?a[b].length=0:a[b]=c.clone(d)}function o(){var b,c,d=p(a),e,f={};for(b=0;b<d.length;b++){e=d[b];for(c=0;c<e.nodes.length;c++)f[e.nodes[c]]=e.nodes.length}return f}function r(){return!c.isNullOrUndefined(a.value)}function s(){return!!a.directed}function u(){return a.endpoints}a=c.defaults(a,{value:undefined,directed:!1,normalization:"component",endpoints:!1,weights:!1,all:!1}),A(a),E(a);var v=r()||s()?"dijkstra":"regular",w=u()?"endpoints":"regular",x=C(a),y={direction:s()?"from":"any",value:a.value,weights:F(a),all:a.all};D(a);var z={},B=[],G=[],H={},I={},J={},K={},L,M,N=a.normalization,O,P,Q,R=0,S,T=[{dict:I,value:0},{dict:K,value:Infinity},{dict:H,value:[]},{dict:J,value:0}],U={regular:function(a){I[a]=1,K[a]=0,B.push(a);while(h(B)){L=B.shift(),G.push(L);for(var b in j[L])b=c.ensureId(b),isFinite(K[b])||(K[b]=K[L]+1,B.push(b)),K[b]===K[L]+1&&(I[b]+=I[L],H[b].push(L))}},dijkstra:function(a,b){I[a]=1,K[a]=0,B.push(a);while(h(B)){L=e(B),G.push(L);for(var d in j[L])d=c.ensureId(d),K[d]>K[L]+g(L,d)&&(K[d]=K[L]+g(L,d),f(B,d),I[d]=0,H[d]=[]),K[d]===K[L]+g(L,d)&&(I[d]+=I[L],H[d].push(L))}}},V={regular:function(a){while(h(G)){M=G.pop(),Q=(1+J[M])/I[M];for(P=0;P<H[M].length;P++)L=H[M][P],J[L]+=I[L]*Q;M!==a&&(z[M]+=J[M])}},endpoints:function(a){z[a]+=G.length-1;while(h(G)){M=G.pop(),Q=(1+J[M])/I[M];for(P=0;P<H[M].length;P++)L=H[M][P],J[L]+=I[L]*Q;M!==a&&(z[M]+=J[M]+1)}}},W={chart:function(){if(R>2){O=1/((R-1)*(R-2));for(var a in z)a=c.ensureId(a),z[a]*=O}},component:function(){S=o();for(var a in z)a=c.ensureId(a),S[a]>2&&(O=1/((S[a]-1)*(S[a]-2)),z[a]*=O)},unnormalized:function(){if(!s()){O=.5;for(var a in z)a=c.ensureId(a),z[a]*=O}}},X=function(){$(),c.invoke(b,z)},Y=U[v]||U.regular,Z=V[w]||V.regular,$=W[x]||W.chart;q(a),l(a,function(a,b){R++}),k(a,z,0);var _=function(a,b){i(),Y(a.id),Z(a.id),b()};m(a,"betweenness",_,X)},J=d.closeness=function(a,b){function d(a,b){var d=0;for(var e in b)e=c.ensureId(e),d+=isFinite(b[e])?1:0;return d}function e(a){for(var b in a){b=c.ensureId(b);if(a.hasOwnProperty(b))return!1}return!0}function g(a){return!c.isNullOrUndefined(a)}function h(a){return!f[a].a1&&!f[a].a2}function i(a){var b={},d=0,f={},h={};h[a]=1;while(!e(h)){f=h,h={};for(var i in f){i=c.ensureId(i);if(!g(b[i])){b[i]=d;for(var k in j[i])k=c.ensureId(k),h[k]=1}}d+=1}return b}function k(){return a.direction!=="any"}function l(){a.mode=a.mode||"auto";if(!a.mode.match(/^(connected|disconnected|auto)$/))throw new TypeError("Option mode property should be either 'connected', 'disconnected' or 'auto'")}function n(){return l(),a.mode==="auto"?u():a.mode}function o(){return!c.isNullOrUndefined(a.value)}function r(){return C(a).match(/chart/)}function t(){return C(a).match(/component/)}function u(){var b="disconnected",c=p(a);if(c.length===1){b="connected";if(k())for(var d=0;d<c[0].links.length;d++)if(h(c[0].links[d]))return"disconnected"}return b}a=c.defaults(a,{direction:"any",value:undefined,normalization:"component",mode:"auto",weights:!1,all:!1});var v=D(a);A(a),E(a),v.all=a.all;var w=o()||k()?"dijkstra":"regular",x,y=0,z={},B,F,H,I=n(),J,K={regular:function(a){return i(a)},dijkstra:function(a,b){return s(a,b)}},L={connected:function(a,b){var d=0;for(var e in b)e=c.ensureId(e),d+=isFinite(b[e])?b[e]:0;return d?1/d:0},disconnected:function(a,b){var d=0;for(var e in b)e=c.ensureId(e),d+=a!==e?1/b[e]:0;return d}},M=function(){c.invoke(b,z)};B=K[w]||K.regular,F=L[I],q(a),y=G(a),z={};var N=function(a,b){H=B(a.id,v),x=d(a.id,H),z[a.id]=F(a.id,H),y>1&&(r()?J=Math.pow(x-1,2)/(y-1):t()?J=x-1:J=1,z[a.id]*=J),b()};m(a,"closeness",N,M)},K=d.bipartite=function(a){function b(a,b,c){return d[a]||(d[a]=b),d[a]===c?!1:!0}var d={},e=!0,f,g,h="r",i,j="b",k=[],m=[];a=c.defaults(a,{all:!1}),E(a),l(a,function(c,d){if(e){e=b(d,h,j),f=o(d,a).nodes;for(g=0;e&&g<f.length;g++)e=b(f[g],j,h);i=h,h=j,j=i}});if(!e)return[];for(var n in d)n=c.ensureId(n),d[n]==="r"?k.push(n):m.push(n);return[k,m]},L=d.kCores=function(a){function d(a){var b=0;for(var d in a)d=c.ensureId(d),b=Math.max(b,a[d]);return b}var b=function(){var b,d,e,f,g,h,i,k,m,n,o={},p={},q=[],r=[],s;d=0,o=H({multi:!1,all:a.all});for(var t in o)t=c.ensureId(t),d=Math.max(d,o[t]);s=c.flattenMap(o).length;for(b=0;b<d+1;b++)r[b]=0;l(a,function(a,b){r[o[b]]++}),g=1;for(b=0;b<d+1;b++)h=r[b],r[b]=g,g+=h;l(a,function(a,b){p[b]=r[o[b]],q[p[b]]=b,r[o[b]]++});for(b=d;b>1;b--)r[b]=r[b-1];r[0]=1;for(f=0;f<s;f++){e=q[f];for(var u in j[e])u=c.ensureId(u),o[u]>o[e]&&(k=o[u],m=p[u],n=r[k],i=q[n],u!==i&&(p[u]=n,q[m]=i,p[i]=m,q[n]=u),r[k]++,o[u]--)}return o};a=c.defaults(a,{all:!1}),E(a),q(a);var e=b();return{maximumK:d(e),values:e}};return d}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Controller={});var b=typeof KeyLinesRequire!="undefined"?require("./rendering"):this.KeyLines.Rendering;a.createController=function(c,d,e){function s(){var a=I();return typeof a.isActuallyTheFlashLoader=="undefined"}function t(a,b){for(var c in a)u(a[c].im)&&(a[c].im=a[b].im)}function u(a){var b=typeof a.naturalWidth!="undefined"&&a.naturalWidth===0;if(/.*\.svg$/.test(a.src)){var c=a.width===28&&a.height===30;return b&&(a.width===0||c)}return b}function v(){return{icon:!0,shown:!1,size:100}}function y(){e.setup();var c=w.watermark;c&&e.addTextWatermark(c.u?o+c.u:undefined,c.t,c.fs||80,c.fc||b.colours.lightgrey,c.fb,c.fbc,c.a,c.ff?c.ff:w.fontFamily),w.navigation&&e.addNavigation(h,m,k,j,b,H),w.overview&&e.addOverview(h,m,j,F,H,w.overview.icon,w.overview.shown,w.overview.size),w.logo&&e.addLogo(o+w.logo),e.remove(J(n,O),J(n,P),J(n,A)),a.e&&e.remove(J(n,O),J(n,P),J(n,A))}function B(a){for(var c=0;c<a.length;c++)for(var d in a[c]){var e=a[c][d];d!=="id"&&typeof e=="string"&&(a[c][d]=b.hsla(e))}}function C(a,c,d){if(typeof a=="number")return a+d*(c-a);if(f.isArray(a)){var e;return Math.abs(a[0]-c[0])>.5?(a[0]<c[0]?e=C(1+a[0],c[0],d):e=C(a[0],1+c[0],d),e-=Math.floor(e)):e=C(a[0],c[0],d),b.fromhsla([e,C(a[1],c[1],d),C(a[2],c[2],d),C(a[3],c[3],d)])}return c}function J(a,b){var c="";for(var d=0;d<b.length;d++)c+=String.fromCharCode(a.charCodeAt(d)+b[d]);return c}function S(a){return 1-a}function T(a){return a}function U(a,b,c,d){var e=c;return{animate:function(g){e-=g;var h=Math.max(0,Math.min(1,(c-e)/c));R=b(h);var i=e>0;return i||(m.resurrect(a,!0),R=.5,f.invoke(d)),i}}}function V(a,b,c,d,e,g){if(a.length===0){f.invoke(g);return}R=c,m.ghost(a);var h=U(a,d,b,g);M(h,e)}function _(){var a=1200,b=0;return{animate:function(c){return b+=c,$=Math.floor(8*(1-b%a/a)),Z}}}function ba(){if(Z){W.reset([b.layers.WAIT]),W.layer(b.layers.WAIT);var a=j.scale(j.width()/2),c=j.scale(j.height()/2),d=j.scale(30);for(var e=0;e<8;e++){var f=e*Math.PI/4,g=a+d*Math.cos(f),h=c+d*Math.sin(f),i=.2+.8*((e+$)%8)/8;W.circle(g,h,j.scale(10),b.colours.white,-1,"rgba(145, 146, 149, "+i+")",!0)}}}function bc(a,b){k.hasOwnProperty("drawImageDirectAlpha")?k.drawImageDirectAlpha(a,0,0,a.width,a.height,0,0,a.width,a.height,b):(k.globalAlpha=b,k.drawImage(a,0,0,j.width(),j.height(),0,0,j.width(),j.height()),k.globalAlpha=1)}function be(a){m.resetDrawingState(),W.reset(),m.generate(W,k,j,i,X,function(a){return!a.gh},o),Y.reset(),m.generate(Y,k,j,i,null,function(a){return a.gh},o),bd=m.getResizePrimitive(),bf(a),e.generate(W,k,j,i,D,!1,a,o),ba()}function bf(a){a||D&&D.generate&&(W.layer(b.layers.DRAGGERS),D.generate(W))}function bg(a,c,d){var e=Q.getContext("2d");b.clear(e),b.draw6(e,c,i,a),bc(Q,d)}function bh(a){b.draw6(a,W,i,b.topLayers),e.drawOverviewContent(a,j),b.draw6(a,W,i,[b.layers.OVERVIEW])}function bi(a){var c=Q.getContext("2d");b.clear(c),bh(c),bc(Q,a)}function bj(){b.clear(k),bb(k),Z?(bg([b.layers.UNDERLAYS],W,.5),bg(b.bgLayers,Y,R*w.backgroundAlpha/2),bg(b.topLayers,Y,R/2),bg(b.bgLayers,W,w.backgroundAlpha/2),bi(.5),b.draw6(k,W,i,[b.layers.WAIT])):(b.draw6(k,W,i,[b.layers.UNDERLAYS]),bg(b.bgLayers,Y,R*w.backgroundAlpha),bg(b.topLayers,Y,R),bg(b.bgLayers,W,w.backgroundAlpha),bh(k))}function bl(){var a=[];if(b_)for(var c=0;c<b_.length;c++)a.push({p:b.primitives.circle,x:b_[c].x,y:b_[c].y,r:20,bc:b.colours.touch,bw:-1,fc:b.colours.touch,fi:!0});return a}function bq(){b.clear(l),b.backFill(l,bo),W.reset([b.layers.OVERLAYS]),e.generate(W,l,j,i,D,!0,!1,o);var a;D&&D.excludeHit&&(a=D.excludeHit()),b.drawShadowCanvas(l,W,F,i,!0,bm,a)}function bv(a,b){return function(){var c=bs(a,b);(m.getByID(c)||!c)&&c!==bu&&(bu=c,d.trigger("hover",f.rawId(c),a,b,f.subId(c)))}}function bw(a,b){bt&&clearTimeout(bt),bt=setTimeout(bv(a,b),x.hover)}function bC(a,b){if(D.scrollable){var c=j.maybeScroll(a,b);M(c)}}function bL(a,b,c,d,e){D&&D.endDrag(a,b,c,d,e),D=null,E("auto"),N()}function bV(){bT&&(clearTimeout(bT),bT=null)}function ca(){bW&&(clearTimeout(bW),bW=null)}var f=typeof KeyLinesRequire!="undefined"?require("./util"):KeyLines.Util,g=typeof KeyLinesRequire!="undefined"?require("./combo"):KeyLines.Combo,h={},i=null,j=null,k=null,l=null,m=null;h.combo=g.create(c);var n="Cambridge Intelligence";h.wait=function(a){return typeof a!="undefined"&&a!==Z&&(Z=a,a&&M(_())),Z};var o="";h.imageBasePath=function(a){return a&&(o=a),o},h.imageList=function(a){return a&&(i=a),i},h.setCanvas=function(a){k=a},h.setView=function(a){j=a},h.setShadowCanvas=function(a){l=a},h.setModel=function(a,b){m=a,m.setDisplayOptions(w)};var p=0,q=null,r=h.afterChange=function(a,c){if(c)y(),N(),f.invoke(a);else{y();var d=m.imageList(o);e.appendImageList(d);var g=s();if(g){var h=H+"Missing.png";d[h]=1}i&&(q=i,i=null),q=q||{};var j={};for(var k in d)q[k]||(j[k]=1);(function(c){b.imageLoader(I,G,j,function(d,j){if(c===p){i=q;for(var k in j)i[k]={im:j[k]};g&&t(i,h),e.colorize(i,F,w.controlColour),b.circularize(i,i,F),N(),f.invoke(a)}})})(++p)}},w={backgroundAlpha:.2,watermark:{fb:!0},overview:v(),navigation:!0};h.displayOptions=function(a,b,c){if(a){a=a||{};for(var d in a)w[d]=a[d],d==="overview"&&(a[d]===!0&&(w[d]=v()),a[d]===!1&&(w[d]=v(),w[d].icon=!1,w[d].shown=!1));m.setDisplayOptions(w),j.setMaxItemZoom(w.maxItemZoom),r(b,c)}return f.clone(w)};var x={handMode:!1,hover:1e3};h.interactionOptions=function(a){return f.merge(x,a),f.clone(x)},h.watermarkSize=function(){return e.getWatermarkSize(k,i)},h.load=function(a){i=null,m.load(a),h.combo.internalUse.loadUp(a.combos)},h.merge=function(a){d.trigger("prechange","merge");var b=h.combo.internalUse.preMerge(a);return m.merge(b)},h.appendCombos=function(a){a.combos=h.combo.internalUse.serialize()},h.postMerge=function(a){h.combo.internalUse.postMerge(a)};var z=h.removeItem=function(a){h.combo.internalUse.preDelete(a),m.removeItem(a)};h.setProperties=function(a,b){return d.trigger("prechange","properties"),m.setProperties(a,b)},h.setViewSettings=function(a,b,c,d){M(j.fromSettingsDirect(a,b,c,d))};var A=[47,6,-11,-58,-64,-52,-48,-59,-51,21,-22,-66,-66,-48,-58,-67];h.animateProperties=function(a,b,c){function j(){var a=[];for(var b=0;b<e.length;b++){var c=m.getByID(e[b].id),d={};for(var f in e[b])if(f!=="id"){var g=c[f];typeof g=="undefined"&&(g=m.defaultValueFor(f)),typeof g!="undefined"&&(d[f]=g)}a.push(d)}return a}d.trigger("prechange","properties");var e=[];for(var g=0;g<a.length;g++){for(var h in a[g])typeof a[g][h]=="undefined"&&(a[g][h]=m.defaultValueFor(h));var i=m.getByID(a[g].id);i&&e.push(a[g])}B(e);var k=b.time,l=d.linearEasing;b.easing==="cubic"&&(l=d.cubicEasing);var n=k,o=!0,p,q={animate:function(a){o&&(p=j(),B(p),o=!1),n-=a;var d=l(Math.max(0,Math.min(1,(k-n)/k))),g=n>0,h=[];for(var i=0;i<e.length;i++){var q={id:e[i].id};for(var r in e[i])r!=="id"&&(q[r]=C(p[i][r],e[i][r],d));h.push(q)}m.applyChanges(h);if(!g)f.invoke(c);else if(b.cb)try{b.cb.call(this,d,k-n)}catch(s){}return g}};M(q,b.queue)};var D=null,E=function(a){};h.setCursorFn=function(a){E=a};var F=function(){};h.setCreateCanvasFn=function(a){F=a};var G="";h.setPath=function(a){G=a};var H;h.assetPath=function(a){return a&&(H=a),H};var I=function(){};h.setImageGenFn=function(a){I=a};var K=[],L=[],M=h.pushAnimation=function(a,b){a&&(b?L.push(a):K.push(a),N())};h.cancelAnimation=function(){K=[],L=[],N()},h.animate=function(a){var b=!1;if(K.length>0){var c=[];for(var d=0;d<K.length;d++)K[d].animate(a)&&c.push(K[d]);K=c,b=!0}K.length===0&&L.length>0&&(K.push(L.shift()),b=!0);var e=ch?ch:D;return e&&e.animate&&(e.animate(a),b=!0),m&&(b=b||m.animated()),b};var N=h.render=function(){d.trigger("redraw")};h.ping=function(a,b){};var O=[8,4,12,-22,-9,5,1,12,-69,37,45,-13,-8,16,-11,8,0,8,9,-78,-67],P=[47,6,-11,-58,-64,-57,-48,-59,-51,19,-16,-66,-66,-48,-58,-67],Q=null;h.makeGhostCanvas=function(a,b){Q=F(a,b)};var R=.5;h.setGhostAlpha=function(a){R=a},h.hide=function(a,b,c){V(a,b,1,S,!0,c)},h.show=function(a,b,c,d){V(a,c,0,T,b,d)};var W=b.instructionPool(),X=b.pool(),Y=b.instructionPool(),Z=!1,$=3,bb=h.drawBackground=function(a){w.backColour?b.backFill(a,w.backColour):w.gradient&&b.backgroundGradient(a,w.gradient.stops)},bd,bk=h.draw=function(a){i&&(be(a),bj())};h.measureText=function(a,c,d,e){return b.measureText(k,a,c,d,e)};var bm=function(){var a={},c={};return{getColour:function(d){if(d in a)return a[d];var e=b.randomColour(c);return a[d]=e,c[e]=d,e},getId:function(a){return c[a]?c[a]:null}}}(),bn=h.drawoffscreen=function(){i&&(Z||(bp=!0))},bo=b.randomColour(),bp=!0;h.afterDraw=function(){D&&D.mouseMoved&&D.mouseMoved()&&D.afterDraw(bs(bD,bE),bD,bE)};var br=5,bs=h.hittest=function(a,c,d){bp&&(bq(),bp=!1);var e=l.getImageData(Math.floor(a),Math.floor(c),1,1).data,f=b.rgbtostring(e[0],e[1],e[2]);if(f===bo)return null;var g=bm.getId(f);return g?g:(d=d||1,d>br?null:a+d>br&&c+d>br?bs(a-1,c-1,++d):bs(a+1,c+1,++d))},bt,bu,bx=h.dragover=function(a,b){bv(a,b)()},by=h.resetState=function(){D=null},bz=h.startDragger=function(a,b,c,d){if(!m)return;c=j.oldToNewX(c),d=j.oldToNewY(d),D=m.startDragger(h,k,j,a,c,d,b),D&&a&&(cursor=D.getCursor(c,d),E(cursor))},bA,bB=h.mousedown=function(a,b,c,g,i){if(!m)return;var l,n;if(D)bL(!0,b,c,g,i);else{l=bs(b,c),bA=l;var o=d.trigger("mousedown",f.rawId(l),j.unscale(b),j.unscale(c),a,f.subId(l));if(m.getByID(l)||!l){var p=!1;a===0?p=!m.isSelected(l)||g||!l:p=!l||!m.isSelected(l),o&&(p=!1),p&&m.setSelection(l,g,i),a===0&&(D=m.createDragger(W,X,h,k,j,l,b,c,x,g,i,bd),D&&l&&(n=D.getCursor(b,c),E(n))),N(),a===2?d.trigger("contextmenu",f.rawId(l),j.unscale(b),j.unscale(c),f.subId(l)):d.trigger("click",f.rawId(l),j.unscale(b),j.unscale(c),a,f.subId(l))}else{a===0&&(D=e.createDragger(l,b,c),D&&l&&(n=D.getCursor(b,c),E(n)));if(a===0||a===1)d.trigger("click",f.rawId(l),j.unscale(b),j.unscale(c),a,f.subId(l)),N()}}},bD,bE,bF,bG=h.mousemove=function(a,b,c,d,f){bD=a,bE=b;var g="auto";if(D&&!f)D.mouseMoved&&D.mouseMoved(!0),bC(a,b),D.dragMove(a,b,c,d),g=D.getCursor(a,b),N();else if(m){var h=m?bs(a,b):null;bw(a,b),m.getByID(h)?h&&(g=m.getCursor(h,H)):g=e.getCursor(h)}bF!==g&&!f&&(E(g),bF=g)},bH=h.mouseup=function(a,b,c,d){D&&bL(!0,a,b,c,d)},bI=h.mouseleave=function(){!D};h.dblclick=function(a,b,c,e){var g=bA;!g&&j&&(d.trigger("dblclick",null,j.unscale(a),j.unscale(b))||bO(!0)),g&&m.getByID(g)&&d.trigger("dblclick",f.rawId(g),j.unscale(a),j.unscale(b),f.subId(g))};var bJ,bK=h.mousewheel=function(a,b,c){if(j){var e=(new Date).getTime();if(bJ&&e-bJ<100)return;bJ=e,d.trigger("mousewheel",a,j.unscale(b),j.unscale(c))||M(j.wheelToPosition(a,b,c))}},bM=h.keyup=function(a){a===27&&bL(!1)},bN=h.keydown=function(a,b,c){if(!m)return;if(d.trigger("keydown",a,b,c))return;if(a===65&&b)return m.selectAll(),N(),!0;if(m.hasSelection()){var e=0,f=0,g=20;switch(a){case 37:e=-g;break;case 38:f=-g;break;case 39:e=g;break;case 40:f=g}if(e!==0||f!==0)return d.trigger("prechange","move"),m.moveSelection(e,f),N(),!0;if(a===46){var h=d.trigger("delete");if(!h){d.trigger("prechange","delete");var i=m.selectionPlusDummyNodes();z(i)}return N(),!0}a===113&&d.trigger("edit",m.doSelection())}return!1};h.panBy=function(a,b,c,d,e){M(j.panBy(a,b,c,!1,d,e)),N()},h.panLeft=function(a,b,c){M(j.panLeft(a,b,c)),N()},h.panRight=function(a,b,c){M(j.panRight(a,b,c)),N()},h.panDown=function(a,b,c){M(j.panDown(a,b,c)),N()},h.panUp=function(a,b,c){M(j.panUp(a,b,c)),N()};var bO=h.zoomIn=function(a,b,c){M(j.zoomIn(a,b,c)),N()},bP=h.zoomOut=function(a,b,c){M(j.zoomOut(a,b,c)),N()};h.setZoom=function(a,b,c,d){M(j.setZoom(a,b,c,d)),N()},h.modelExtents=function(){return j.modelExtents(m,k,i,b,o)},h.fitToModel=function(a,c,d){i&&m&&(M(j.fitToModel(m,k,i,b,a,c,d,o)),N())},h.fitToSelection=function(a,c,d){i&&m&&(M(j.fitToSelection(m,k,i,b,a,c,d,o)),N())},h.fitModelHeight=function(a,c,d){i&&m&&(M(j.fitModelHeight(m,k,i,b,a,c,d,o)),N())};var bQ=h.extractStructure=function(a,b){var c=a!=="radial";return b=f.defaults(b,{fixed:[]}),m.extractStructure(k,b.fixed,c)},bR=function(a,b){var c=a;return{animate:function(a){c-=a;var d=c<0;return d&&f.invoke(b),!d}}},bS=h.finishLayout=function(a,b,c,d){var e,f;if(a){var g=Math.max(0,Math.min(b.ms||700,2e3)),h=a.extents;e=m.makeAnimator(a.vertices,g),f=j.fitWorldExtents(a.extents,!0,!0,!0,!0,g,d),b.animate?(M(e),b.fit?M(f):h&&M(bR(g,d))):(m.applyVertices(a.vertices),h&&(b.fit?j.fitWorldExtents(a.extents,!1,!0,!0,!0,0,d):M(bR(g,d))),N())}};h.layout=function(a,b,c,e){function f(a,b,c){bS(a,b,c,e)}if(m){b=b||{};var g=null,h=bQ(a,b);m.layout(a,d,h,b,c,f)}};var bT,bU,bW,bX,bY,bZ,b$,b_;h.touchstart=function(a,b){b_=a,a.length===2&&(cf=(a[0].x+a[1].x)/2,cg=(a[0].y+a[1].y)/2,cd=cf,ce=cg);if(a.length===1){bX=a[0].x,bY=a[0].y,b$=a[0].id;var c=bs(bX,bY);bT?c!==bZ?bV():bU=!0:(bU=!1,bT=setTimeout(bV,600)),bZ=c,bW=setTimeout(function(){ca(),D&&bL(!1),d.trigger("contextmenu",f.rawId(bZ),j.unscale(bX),j.unscale(bY),f.subId(bZ))},600);if(m.getByID(bZ)||!bZ){var g=d.trigger("touchdown",f.rawId(bZ),j.unscale(bX),j.unscale(bY),f.subId(bZ));g||(bZ?m.isSelected(bZ)||m.setSelection(bZ,!1,!1):m.setSelection(null,!1,!1)),D=m.createDragger(W,X,h,k,j,bZ,bX,bY,x,undefined,undefined,bd),N()}else D=e.createDragger(bZ,bX,bY)}};var cb,cc,cd,ce;h.touchmove=function(a,b){b_=a,a.length>=2&&(cd=(a[0].x+a[1].x)/2,ce=(a[0].y+a[1].y)/2);for(var c=0;c<a.length;c++)b$===a[c].id&&(cb=a[c].x,cc=a[c].y);if(bW){var d=(cb-bX)*(cb-bX)+(cc-bY)*(cc-bY);d>100&&ca()}ch||D&&b$===a[0].id&&a.length===1&&(bC(a[0].x,a[0].y),D.dragMove(a[0].x,a[0].y,!1,!1),N())},h.touchend=function(a,b){b_=a,N(),bW&&(ca(),d.trigger("click",f.rawId(bZ),j.unscale(bX),j.unscale(bY),0,f.subId(bZ)));if(bT&&bU){bV();var c=d.trigger("dblclick",f.rawId(bZ),j.unscale(bX),j.unscale(bY),f.subId(bZ));c||bZ||bO(!0)}if(!ch&&D){var e=-1;for(var g=0;g<b.length;g++)b[g].id===b$&&(e=g);if(e>-1&&a.length===0)bL(!0,b[e].x,b[e].y,!1,!1);else if(a.length>0){bX=a[0].x,bY=a[0].y,b$=a[0].id,bZ=bs(bX,bY);if(m.getByID(bZ)||!bZ)m.setSelection(bZ,!1,!1),D=m.createDragger(W,X,h,k,j,bZ,bX,bY,x,undefined,undefined,bd)}}},h.touchcancel=function(a,b){ca(),D&&bL(!1)};var cf,cg,ch;return h.gesturestart=function(){},h.gesturechange=function(a,b){ca(),ch||(ch=m.createGestureDragger(j,cf,cg)),ch.dragMove(a,b,cd,ce),N()},h.gestureend=function(a,b){ch&&(ch.endDrag(!0,a,b,cd,ce),!D),ch=null},h}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Model={});var b=typeof KeyLinesRequire!="undefined"?require("./rendering"):this.KeyLines.Rendering,c=typeof KeyLinesRequire!="undefined"?require("./graph"):this.KeyLines.Graph;a.createModel=function(a,d){function m(a){return Math.abs(a)<1e-5}function n(a,b,c,d,e,f){return{x:((e-c)*Math.cos(b)-(f-d)*Math.sin(b))/a,y:((e-c)*Math.sin(b)+(f-d)*Math.cos(b))/a}}function o(a,b,c,d,e,f,g,h,i){var j=n(b,-c,d,e,f,g),k=n(b,-c,d,e,h,i);a/=b;if(j.y>a&&k.y>a||j.y<-a&&k.y<-a)return NaN;if(m(k.y-j.y))return Math.max(j.x,k.x);var l=j.y>k.y?j:k,o=j.y>k.y?k:j,p;a<l.y?p=l.x-(l.y-a)*(l.x-o.x)/(l.y-o.y):p=l.x;var q;return o.y<-a?q=o.x-(o.y- -a)*(o.x-l.x)/(o.y-l.y):q=o.x,Math.max(p,q)}function p(a,b,c,d,e,f){var g=-Infinity;for(var h=0;h<f.length;h++){var i=(h+1)%f.length,j=o(a,b,c,d,e,f[h].x,f[h].y,f[i].x,f[i].y);isNaN(j)||(g=Math.max(g,j))}return g}function q(a,b,c,d,e,f){return p(a,b,c,d,e,[{x:f.x1,y:f.y1},{x:f.x2,y:f.y1},{x:f.x2,y:f.y2},{x:f.x1,y:f.y2}])}function r(a,b,c,d,e,f){var g=-Infinity;for(var h=0;h<f.length;h++)g=Math.max(g,q(a,b,c,d,e,f[h]));return g}function s(a,b,c,d,e,f){var g=0;return d._c&&(g=d._c/b),d._cl&&(g=Math.max(g,r(a,b,c,e,f,d._cl))),g}function t(a,b,c,d,e,f,g,h,i){var j={},k=Math.sqrt((c-a)*(c-a)+(d-b)*(d-b));if(m(k))j.skip=!0;else{var l=Math.atan2(d-b,c-a),n=s(f,k,l,g,a,b),o=s(f,k,l+Math.PI,h,c,d),p=i.b1?i.b1:0,q=i.b2?i.b2:0;n=Math.max(p,n),o=Math.max(q,o);var r=.1;j.skip=n+o+r>1,j.skip||(j.cx1=a+n*(c-a),j.cy1=b+n*(d-b),j.cx2=c+o*(a-c),j.cy2=d+o*(b-d))}return j}function u(a,b){switch(a){case"x1":return h[b.id1].x;case"y1":return h[b.id1].y;case"x2":return h[b.id2].x;case"y2":return h[b.id2].y}}function v(a,b,c,d,e,f,g){var h=e-c;if(Math.abs(h)>d)return[];var i=Math.max(f,g),j=Math.min(f,g);if(i<b-d||b+d<j)return[];var k=Math.asin(h/d),l=d*Math.cos(k),m=[];return j<b-l&&b-l<i&&m.push(h>0?Math.PI-k:-Math.PI-k),j<b+l&&b+l<i&&m.push(k),m}function w(a,b,c,d,e,f,g){var h=e-b;if(Math.abs(h)>d)return[];var i=Math.max(f,g),j=Math.min(f,g);if(i<c-d||c+d<j)return[];var k=Math.acos(h/d),l=d*Math.sin(k),m=[];return j<c-l&&c-l<i&&m.push(-k),j<c+l&&c+l<i&&m.push(k),m}function x(a,b,c,d,e,f,g,h){var i=Math.PI/2,j=h?e:f;g._c&&(j+=(h?1:-1)*g._c/d);if(g._cl&&g._cl.length>0)for(var k=0;k<g._cl.length;k++){var l=g._cl[k],m=v(a,b,c,d,l.y2,l.x1,l.x2),n=v(a,b,c,d,l.y1,l.x1,l.x2),o=w(a,b,c,d,l.x1,l.y1,l.y2),p=w(a,b,c,d,l.x2,l.y1,l.y2),q=m.concat(n,p,o);for(var r=0;r<q.length;r++)q[r]+2*Math.PI<f&&(q[r]+=2*Math.PI),e<q[r]&&q[r]<f&&(h?q[r]-j<i&&(j=Math.max(j,q[r])):j-q[r]<i&&(j=Math.min(j,q[r])))}return j}function y(a,b,c,d,e,f,g,h,i){var j=x(a,c,d,e,f,g,b>0?h:i,!0),k=x(a,c,d,e,j,g,b>0?i:h,!1);return{startangle:j,endangle:k}}function z(a,b,c,d,e,f,g,i,j,k){var m=Math.floor((e+g)/2),n=Math.floor((f+i)/2),o=g-e,p=i-f,q=a.dim2(c.off);q===0&&(q=c.off<0?-1:1);var r=Math.max(.001,p*p+o*o),s=Math.sqrt(r),t=(r/4+q*q)/(2*Math.abs(q)),u=t-Math.abs(q),v=q>0?1:-1,w=m-p*v*u/s,x=n+o*v*u/s,z=Math.atan2(f-x,e-w),A=Math.atan2(i-x,g-w),B=q>0?z:A,C=q>0?A:z;B>C&&(C+=Math.PI*2);var D=c.b1?c.b1:0,E=c.b2?c.b2:0,G=B+(q>0?D:E)*(C-B),H=B+(q>0?1-E:1-D)*(C-B),I=y(k,q,w,x,t,B,C,h[c.id1],h[c.id2]);I.startangle=Math.max(G,I.startangle),I.endangle=Math.min(H,I.endangle);if(I.startangle<I.endangle){var J=(I.startangle+I.endangle)/2,K={};K.lx=w+t*Math.cos(J),K.ly=x+t*Math.sin(J);var L,M,N,O=1.5*k/t;return c.a1&&(L=q>0?I.startangle:I.endangle,M=w+t*Math.cos(L),N=x+t*Math.sin(L),F(a,b,M,N,k,+v*O*.66+L-v*Math.PI/2,j,d+l+"a1"),q>0?I.startangle+=O:I.endangle-=O),c.a2&&(L=q>0?I.endangle:I.startangle,M=w+t*Math.cos(L),N=x+t*Math.sin(L),F(a,b,M,N,k,-v*O*.66+L+Math.PI-v*Math.PI/2,j,d+l+"a2"),q>0?I.endangle-=O:I.startangle+=O),I.startangle<I.endangle&&b.arc(Math.floor(w),Math.floor(x),t,I.startangle,I.endangle,j,k,d),K}return}function A(a,b,c,d,e,f,g,i,j,k){var m=t(e,f,g,i,a,k,h[c.id1],h[c.id2],c);if(m.skip)return;var n=m.cx1,o=m.cy1,p=m.cx2,q=m.cy2,r=p-n,s=q-o,u=Math.max(.001,s*s+r*r),v=Math.sqrt(u),w,x,y;c.a1&&(w=Math.atan2(s,r),F(a,b,n,o,k,w+Math.PI,j,d+l+"a1"),n+=1.5*k*r/v,o+=1.5*k*s/v),c.a2&&(w=Math.atan2(s,r),F(a,b,p,q,k,w,j,d+l+"a2"),p-=1.5*k*r/v,q-=1.5*k*s/v),b.line(Math.floor(n),Math.floor(o),Math.floor(p),Math.floor(q),j,k,d);var z={};return z.lx=(n+p)/2,z.ly=(o+q)/2,z}function B(a,b,c,d){if(a){var e=a.getNext();e.x=b,e.y=c,e.id=d}}function C(a,c,d,e,f,g,i){if(e.hi)return;var k=bY(f),m=c.x(h[e.id1].x),n=c.y(h[e.id1].y),o=c.x(h[e.id2].x),p=c.y(h[e.id2].y),q,r=c.w(e.w?e.w:1),s=e.c?e.c:b.colours.midgrey,t;e.off?t=z(c,d,e,f,m,n,o,p,s,r):t=A(c,d,e,f,m,n,o,p,s,r);var u=t?t.lx:(m+o)/2,v=t?t.ly:(n+p)/2;e._x=c.newToOldX(u),e._y=c.newToOldY(v);if(!t)B(g,u,v,f);else{var w=t.lx,x=t.ly,y=w,C=x,F=U(e),H=Number(e.fs?e.fs:j),L=c.dim(H),O=!1;if(M(e)){var P=e.fc?e.fc:b.colours.black,Q=e.fbc?e.fbc:b.colours.textback;k&&(P=bD(),Q=bC());var R=I(e),S=J(R,a,L,e),T=K(S),V=c.dim(H+3);for(q=0;q<R.length;q++)if(q===0||q==="0")y-=S[0]/2;var W=x-Math.round((R.length-1)*V/2);for(var Y=0;Y<R.length;Y++){if(q===0||q==="0")C=W;var Z=N(a,c,d,R[Y],w,W,L,f,!0,P,Q,e.fb,e,!1,99,S[Y],k,H,e.ff||bz);O=O||Z,W+=V}}var $=!M(e)||!O;$&&k&&d.circle(w,x,Math.floor(L/2),b.colours.white,-1,bC(),!0,f);if(F){y-=c.dim(D);var _=c.dim(E);for(q=e.g.length-1;q>=0;q--)X(d,c,a,f+l+q,y,C,1,e.g[q],i),y-=_}!F&&!M(e)&&B(g,w,x,f)}G(e,"id1",f,m,n,d,r,s),G(e,"id2",f,o,p,d,r,s)}function F(a,b,c,d,e,f,g,h){var i=e*1.7+a.dim(10),j=Math.PI/7;b.triangle(c+i*Math.cos(f+Math.PI+j),d+i*Math.sin(f+Math.PI+j),c+i*Math.cos(f+Math.PI-j),d+i*Math.sin(f+Math.PI-j),c,d,g,-1,g,!0,h)}function G(a,c,d,e,f,g,i,j){h[a[c]].du&&g.circle(e,f,Math.floor(i*1.5),j,i,b.colours.white,!0,d+l+c)}function I(a){return(a.t+"").split(/\r\n|\r|\n/)}function J(a,c,d,e){var f=[];for(var g=0;g<a.length;g++)f[g]=b.measureText(c,a[g],d,e.fb,e.ff||bz).width;return f}function K(a){var b=0;for(var c=0;c<a.length;c++)b=Math.max(b,a[c]);return b}function L(a,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){var t=b.measureText(a,e,h,m,s).width;return N(a,c,d,e,f,g,h,i,j,k,l,m,n,o,p,t,q,r,s)}function M(a){return a.hasOwnProperty("t")&&a.t}function N(a,b,c,d,e,f,g,h,i,j,k,m,n,o,p,q,r,s,t){if(d.length===0)return;var u=h+l+"t";if(o&&q>p&&g>3)return L(a,b,c,d,e,f,Math.floor(g*.85),h,i,j,k,m,n,o,p,r,s,t);var v=b.dim(4),w=Math.floor(e-Math.round(q/2)),x=Math.floor(f+Math.round(1+g/2)),y={x1:w-v,y1:x-g,x2:w+Math.floor(q)+v,y2:x};if(g>3)return i&&c.rect(y.x1,y.y1,y.x2,y.y2,k,-1,k,!0,u),n&&(n._edit=y,n._edit.fs=g,n._cl&&n._cl.push(y)),c.text(w,x,d,j,Math.round(g),m,u,t),!0;n&&(n._edit=null),y.y1-=1,y.y2-=1,y.y1===y.y2&&y.y2++;if(g===0){var z=b.dim(s*d.length*.2),A=Math.floor((y.x2+y.x1)/2);y.x2=A+z,y.x1=A-z}n&&n._cl&&n._cl.push(y);if(i&&r)c.rect(y.x1,y.y1,y.x2,y.y2,k,-1,k,!0,u);else{var B=P(j,.4);c.rect(y.x1,y.y1,y.x2,y.y2,B,-1,B,!0,u)}return!0}function P(a,c){var d=a+c;return O[d]||(O[d]=b.alphaize(a,c)),O[d]}function Q(a){return a.w&&a.h}function T(a,c,d,f,g,h,i,k){if(g.hi)return;if(g.du)return;var m,n,o=g.e?g.e:1,p=Math.floor(R*o),q=p,r=Q(g),s=bY(h);r&&(p=Math.floor(g.w/2),q=Math.floor(g.h/2),o=1);var t=r?c.dim2(p):c.dim(p),u=r?c.dim2(q):c.dim(q),v=c.x(g.x),w=c.y(g.y);g._c=0,g._cl=[];var x=c.w(g.bw?g.bw:S),y=g.hasOwnProperty("c")&&g.c?!0:!1,z=g.hasOwnProperty("b")&&g.b?!0:!1,A=z?g.b:b.colours.white,B=z?Math.floor(x*o):-1,C=y?g.c:b.colours.white,F=V(g);(y||z)&&r&&(g.sh==="circle"?f.circle(v,w,Math.min(t,u),A,B,C,y,h):f.rect(v-t,w-u,v+t,w+u,A,B,C,y,h));if((z||y)&&!r){var G;g.sq?(G=c.dim(28*o),f.rect(v-G,w-G,v+G,w+G,A,B,C,y,h)):(G=c.dim(27*o),f.circle(v,w,G,A,B,C,y,h))}var H;if(F||z||y)if(r){var L={x1:v-t-x,y1:w-u-x,x2:v+t+x,y2:w+u+x};g.sh==="circle"?g._c=Math.min(t,u)+x+2:g._cl.push(L),s&&(g.re&&!F&&(cc=e.clone(f.getLast())),g.sh==="circle"?f.rect(v-Math.min(t,u)-x,w-Math.min(t,u)-x,v+Math.min(t,u)+x,w+Math.min(t,u)+x,bC(),x,bC(),!1,h):f.rect(L.x1,L.y1,L.x2,L.y2,bC(),x,bC(),!1,h),g.re&&(cd=f.getLast()))}else if(g.sq){H=c.dim(31*o);var O={x1:v-H,y1:w-H,x2:v+H,y2:w+H};g._cl.push(O),s&&f.rect(O.x1,O.y1,O.x2,O.y2,bC(),Math.floor(x*o),bC(),!1,h)}else H=c.dim(30*o),g._c=c.dim(32*o),s&&f.circle(v,w,H,bC(),Math.floor(x*o),bC(),!1,h);F&&(f.image(v-t,w-u,v+t,w+u,k+g.u,h,g.ci?"ci":undefined),s&&r&&g.re&&(cc=e.clone(f.getLast())));var P=v,T=w,Z=U(g),$;if(M(g)){var _=Math.floor((g.fs?g.fs:j)*o),ba=c.dim(_),bb=c.dim(5*o+_/2),bc=g.fc?g.fc:b.colours.black,bd=g.fbc?g.fbc:b.colours.textback;s&&(bc=bD(),bd=bC());var be=w+u+bb,bf=c.dim(_+3),bg=I(g),bh=J(bg,a,ba,g),bi=K(bh);for($=0;$<bg.length;$++)if($===0||$==="0")P-=bh[0]/2;var bj=!1;r?g.tc&&(bj=!0):F||(bj=!0);if(bj)if(Z){var bk=c.dim(D*o);P=v+bk,!y&&!z&&(v+=Math.floor(bh[0]/2+bk)),be=w,g._c=bk}else be=w-Math.round((bg.length-1)*bf/2);for(var bl=0;bl<bg.length;bl++){if($===0||$==="0")T=be;N(a,c,f,bg[bl],v,be,ba,h,!0,bc,bd,g.fb,g,!1,99,bh[bl],s,_,g.ff||bz),be+=bf}}if(Z)if(F||z||y){var bm=Math.floor(4*o),bn=Math.floor((F?12:4)*o);if(g.g.length)for($=0;$<g.g.length;$++){var bo=g.g[$];switch(bo.p){case"ne":W(f,c,a,h+l+"ne",g.x,g.y,p-bm,-q+bn,o,bo,k);break;case"nw":W(f,c,a,h+l+"nw",g.x,g.y,-p+bm,-q+bn,o,bo,k);break;case"sw":W(f,c,a,h+l+"sw",g.x,g.y,-p+bm,+q-bn,o,bo,k);break;case"se":W(f,c,a,h+l+"se",g.x,g.y,p-bm,q-bn,o,bo,k)}}}else{P-=c.dim(D*o);var bp=c.dim(E*o);for($=g.g.length-1;$>=0;$--)X(f,c,a,h+l+$,P,T,o,g.g[$],k),P-=bp}g.bu&&Y(f,c,a,h,v,w,o,g.bu,k)}function U(a){return a.hasOwnProperty("g")&&e.isArray(a.g)&&a.g.length>0}function V(a){return a.hasOwnProperty("u")&&a.u}function W(a,b,c,d,e,f,g,h,i,j,k){var l=b.x(e)+b.dim(g),m=b.y(f)+b.dim(h);X(a,b,c,d,l,m,i,j,k)}function X(a,c,d,e,f,g,h,i,j){if(i){var l=i.a?bQ:1,m=c.dim(9*h*l);if(i.c){a.circle(f,g,m,b.colours.keyline,c.w(2*h),i.c,!0,e);if(i.t){var n=(i.t+"").substring(0,3),o=h*k[n.length-1];L(d,c,a,n,f,g,c.dim(h*k[n.length-1]),e,!1,b.colours.white,b.colours.white,!0,null,!0,m*1.7,!1,o,i.ff||bz)}else if(i.u){var p=Math.floor(m/1.414);a.image(f-p,g-p,f+p,g+p,j+i.u,e)}}else i.u&&a.image(f-m,g-m,f+m,g+m,j+i.u,e);bR=bR||i.a}}function Y(a,c,d,e,f,g,h,i,k){if(i.t){var m=a.layer();a.layer(b.layers.BUBBLES);var n=i.p?""+i.p:"ne",o=n.substring(1,2)==="w",p=n.substring(0,1)==="s",q=e+l+"bu"+n,r=Number(i.fs?i.fs:j),s=i.b?i.b:b.colours.keyline,t=i.c?i.c:b.colours.white,u=i.fbc?i.fbc:b.colours.transparent,v=i.fc?i.fc:b.colours.black,w=c.dim(r),x=I(i),y=c.dim(r+3),z=J(x,d,w,i),A=K(z),B=y*x.length,C=J(x,d,r,i),D=K(C);maxWidth=c.dim(D*w/r);var E=D*w/r,F=13,G=6,H=2*h,L=36*h,M=9,N=13,O=10,P=B+c.dim(2*G),Q=c.dim(2),R=Math.max(Math.floor(Q/2),1),S=Math.max(c.dim(3),1),T=i.g?17:0;o&&(f-=c.dim(D+2*H+2*F+T)),p&&(g+=c.dim((r+3)*x.length+2*L+2*G));var U=f+c.dim(H)+.5,V=f+c.dim(H+2*F+D+T)+.5,W=g-c.dim(L)-P+.5,Y=g-c.dim(L)+.5;a.round(U,W,V,Y,c.dim(8),s,Q,t,!0,q),X(a,c,d,q,f+c.dim(T),(W+Y)/2,1,i.g,k);var Z=g-c.dim(L+G+(r+3)*x.length-(r+3)/2-r/2)+1,$=U+c.dim(F+T)-.5,_=Math.round(w/2);for(var ba=0;ba<x.length;ba++)a.text($,Z,x[ba],v,w,i.fb,q,i.ff||bz),Z+=y;o&&(U=V,M=-M,O=-O,R=-R),p&&(Y=W,N=-N,S=-S),Math.abs(c.dim(O))>3&&(a.triangle(U+c.dim(M),Y,U+c.dim(M+O),Y,U+c.dim(M),Y+c.dim(N),s,Q,t,!0,q),a.triangle(U+c.dim(M)+R,Y-S,U+c.dim(M+O)+R,Y-S,U+c.dim(M)+R,Y+c.dim(N)-S,s,-1,t,!0,q)),a.layer(m)}}function $(a){a.type==="node"&&(a.x||(a.x=0),a.y||(a.y=0))}function _(a,b){var c={},d={};if(a)for(var f=0;f<a.length;f++){var g=a[f];if(g.id&&!(g.id in c)&&!(g.id in d)){var i=null;if(g.type==="node"){i=c;var j=!0;b&&h[g.id]&&(j=!1),j&&$(g)}g.type==="link"&&(i=d),i&&(i[g.id]=e.clone(g))}}return{nodes:c,links:d}}function ba(){var a,b,c=[];for(a in i)b=e.clone(i[a],!0),b.id=e.ensureId(a),c.push(b);for(a in h)b=e.clone(h[a],!0),b.id=e.ensureId(a),c.push(b);return c}function bb(a){bc(a.items)}function bc(a){if(a)for(var b=0;b<a.length;b++)bd(a[b])}function bd(a){bi(a),a.g&&(e.isArray(a.g)?bi(a.g):delete a.g)}function be(a){var b=[];for(var c in a)(typeof a[c]=="undefined"||a[c]===null)&&b.push(c);for(c in b)delete a[b[c]]}function bi(a){var b,c;if(a){for(c=0;c<bf.length;c++)b=bf[c],a[b]&&(a[b]=Number(a[b]));for(c=0;c<bg.length;c++)b=bg[c],a[b]&&(a[b]=a[b]+"")}}function bj(a){var b={};for(var c in a)a[c].id1!==a[c].id2&&(b[c]=a[c]);return b}function bk(a,b){var c={};for(var d in a)bl(a[d],b)&&(c[d]=a[d]);return c}function bl(a,b){return b=b||{},(h[a.id1]||b[a.id1])&&(h[a.id2]||b[a.id2])}function bm(a,b){for(var c in i){var d=i[c];if(h[d.id1][a]===b||h[d.id2][a]===b)i[c][a]=b}}function bn(a,b){a[b]&&bW(a.id,!0)}function bo(a){for(var b in i)bn(i[b],a);for(b in h)bn(h[b],a)}function bp(){bq("hi")}function bq(a,b){bm(a,!0),b||bo(a)}function br(a,b,c){for(var d=0;d<a.length;d++)h[a[d]]&&(h[a[d]][b]=c),i[a[d]]&&(i[a[d]][b]=c)}function bs(a,b){var c=!1;return h[a]&&(c=bu(h[a],b)),i[a]&&(c=bu(i[a],b)),c}function bt(a){return!bs(a,"hi")&&!bs(a,"gh")}function bu(a,b){return a[b]?!0:!1}function bv(a,b,c){a=e.ensureArray(a),br(a,b,!1),bq(b);if(c){var d={};for(var f in a)d[a[f]]=1;for(f in i)bu(i[f],b)&&!bu(h[i[f].id1],b)&&!bu(h[i[f].id2],b)&&(d[i[f].id1]||d[i[f].id2])&&(i[f][b]=!1)}}function bw(a){var b=[];for(var c in h)c=e.ensureId(c),h[c][a]&&b.push(c);for(c in i)c=e.ensureId(c),i[c][a]&&b.push(c);return b}function bx(a,b){a=e.ensureArray(a),br(a,b,!0),bq(b)}function bC(){return bA||b.colours.edit}function bD(){return bB||b.colours.white}function bH(a){var b={};for(var c in a)typeof a[c].off=="undefined"&&(b[c]=a[c]);return b}function bM(){var a=!1,b,c,d,e;for(var f in h){b=h[f],b.u&&(b.u in bK||(bK[b.u]=1,a=!0));if(U(b))for(e=0;e<b.g.length;e++)d=b.g[e],d&&d.u&&(bK[d.u]=1,a=!0)}for(var g in i){c=i[g];if(U(c))for(e=0;e<c.g.length;e++)d=c.g[e],d&&d.u&&(bK[d.u]=1,a=!0)}return a}function bO(a){var c=Q(a);return a.bg?c?b.layers.BGSHAPES:b.layers.BGNODES:c?b.layers.SHAPES:b.layers.NODES}function bP(a){return a.bg?b.layers.BGLINKS:b.layers.LINKS}function b$(a){for(var b in a)bV(b,!0)}function cg(a){return(a+"").match(ce)}function ch(a){var b=cg(a);return cf[b[2]]}function ci(a){var b=cg(a);return b?b[1]:null}var e=typeof KeyLinesRequire!="undefined"?require("./util"):KeyLines.Util,f=typeof KeyLinesRequire!="undefined"?require("./layouts"):KeyLines.Layouts,g={},h={},i={};g.graph=c.create(g,a),g.graph.privateSetProperties(h,i);var j=14,k=[12,9,7],l=e.idSep(),D=13,E=21,H=g.labelPosition=function(a,b){var c=bJ(a),d=c._edit;if(d){var e=["x1","x2","y1","y2","fs"];for(var f=0;f<e.length;f++)d[e[f]]=b.unscale(d[e[f]])}return c?c.hi?null:c._edit:null},O={},R=26,S=4;g.nodeTextWidth=function(a,b){var c=0,d=0;if(M(a)){var e=Math.floor((a.fs?a.fs:j)*(a.e?a.e:1)),f=I(a),g=J(f,b,e,a);c=K(g),d=e*(f.length+1),V(a)||(c/=10)}return{width:c,height:d}};var Z=g.load=function(a){if(a){h={},i={},bb(a);var b=_(a.items);h=b.nodes,i=bk(b.links),i=bj(i),bp(),f.setUpUninitializedConnections(i),g.graph.privateSetProperties(h,i)}bM()};g.defaultValueFor=function(a){switch(a){case"e":return 1;case"fs":return j;case"off":return 0;case"x":case"y":return 0;case"w":case"h":return 1;case"c":case"b":return b.colours.midgrey;case"fc":return b.colours.black;case"fbc":return b.colours.textback}};var bf=["x","y","w","h","e","fs","off","b1","b2","bw"],bg=["t","u","id","id1","id2","ff","sh","p"],bh=["c","b","fc","fbc"];g.bothEndsShown=function(a){return!h[a.id1].hi&&!h[a.id2].hi},g.ensureBackgroundConsistency=function(){bq("bg",!0)},g.resurrect=function(a,b){bv(a,"gh",b)},g.ghost=function(a){bx(a,"gh")},g.show=function(a,b){bv(a,"hi",b)},g.hidden=function(){return bw("hi")},g.hide=function(a){bx(a,"hi")},g.each=function(a,b){if(a.type.match(/^(node|all)$/))for(var c in h)b(h[c]);if(a.type.match(/^(link|all)$/))for(var d in i)b(i[d])},g.setItem=function(a){bd(a);var b=null;a.type==="node"&&(b=h);if(a.type==="link"){b=i;if(!bl(a))return!1}return $(a),a.id&&(b[a.id]=e.clone(a),a.hi&&bp()),bM()};var by=g.type=function(){return"LinkChart"},bz,bA,bB;g.setDisplayOptions=function(a){bA=a.selectionColour,bz=a.fontFamily,bB=a.selectionFontColour};var bE=g.serialize=function(a){return{type:by(),items:ba()}},bF=g.applyChanges=function(a,b){var c,d,f,g,j,k,l;for(c=0;c<a.length;c++){d=e.rawId(a[c].id);if(d){k=[];if(b){l=new RegExp(d,"im");for(f in h)l.test(f)&&k.push(h[f]);for(g in i)l.test(g)&&k.push(i[g])}else h[d]&&k.push(h[d]),i[d]&&k.push(i[d])}var m=e.clone(a[c]);delete m.id,delete m.type;for(j=0;j<k.length;j++)k[j]=e.merge(k[j],m),be(k[j])}},bG=g.setProperties=function(a,b){a=e.ensureArray(a),bc(a),bF(a,b),bp();var c=bM();return c},bI=g.merge=function(a,b){b=b||{},bc(a);var c=_(a,!0);c.links=bk(c.links,c.nodes),c.links=bj(c.links);for(var d in c.nodes)h[d]=e.merge(h[d],c.nodes[d]);for(var g in c.links)i[g]=e.merge(i[g],c.links[g]);if(!b.preserveOffsets){var j=bH(c.links);f.resetConnectionOffsets(i,j)}bp();var k=bM();return k};g.getItem=function(a){var b=bJ(a);return e.clone(b,!0)};var bJ=g.getByID=function(a){return a=e.rawId(a),h[a]?h[a]:i[a]};g.isNode=function(a){return a=e.rawId(a),h[a]?!0:!1},g.randomWalker=function(){var a=!0,b={};return{animate:function(c){var d;if(a){var e=.05;for(d in h)b[d]={vx:(Math.random()-.5)*e,vy:(Math.random()-.5)*e};a=!1}else for(d in h){h[d].x+=c*b[d].vx,h[d].y+=c*b[d].vy;if(h[d].x<0||h[d].x>842)b[d].vx=-b[d].vx;if(h[d].y<0||h[d].y>596)b[d].vy=-b[d].vy}return!0}}};var bK={},bL=g.imageList=function(a){var b={};for(var c in bK)b[a+c]=1;return b};g.resetDrawingState=function(){bR=!1,cc=null,cd=null};var bN=g.generate=function(c,d,e,f,g,j,k){var m,n,o,p;bQ=a.atanEasing((new Date).getTime()%1e3/1e3),g&&g.reset();for(m in h){n=h[m];if(!j||j(n))p=bO(n),c.layer(p),T(d,e,f[n.u],c,n,m,g,k)}for(m in i){o=i[m];if(!j||j(o))p=bP(o),c.layer(p),C(d,e,c,o,m,g,k)}c.layer(b.layers.HANDLES),cd&&bT.length===1&&b.getHandles(c,d,cd,1,cd.id,bC(),l)};g.generateSelection=function(a,b,c,d,e,f){bN(a,b,c,d,e,function(a){return a.id in bS},f)};var bQ,bR;g.animated=function(){return bR};var bS={},bT=[],bU=g.setSelection=function(a,b,c){a=e.rawId(a),!b&&!c&&bZ(a),bS[a]?b&&bW(a):bV(a)},bV=g.addToSelection=function(b,c){b=e.rawId(b),b&&(bS[b]||bt(b)&&(bS[b]=1,bT.push(b),c||a.trigger("selectionchange")))},bW=g.removeFromSelection=function(b,c){b=e.rawId(b);if(bS[b]){delete bS[b];var d=e.indexOf(bT,b);d>-1&&bT.splice(d,1),c||a.trigger("selectionchange")}},bX=g.hasSelection=function(){return bT.length>0},bY=g.isSelected=function(a){return a=e.rawId(a),a in bS},bZ=g.clearSelection=function(b){bS={},bT=[],b||a.trigger("selectionchange")};g.selectAll=function(){b$(h),b$(i),a.trigger("selectionchange")};var b_=g.doSelection=function(a){if(a){bZ(!0);for(var b=0;b<a.length;b++)bV(a[b],!0)}return e.clone(bT)};g.moveSelection=function(a,b){var c=[];if(bS){for(var d in h)bY(d)&&c.push(d);for(var e in i)bY(e)&&(h[i[e].id1].du&&c.push(i[e].id1),h[i[e].id2].du&&c.push(i[e].id2))}for(var f=0;f<c.length;f++){var g=h[c[f]];g.x+=a,g.y+=b}};var ca=g.removeItem=function(a,b){b=b||{};var c;a=e.ensureArray(a);var d={},g={};for(var j=0;j<a.length;j++)c=a[j],i[c]&&(d[c]=i[c]),h[c]&&(g[c]=1);for(c in i)if(g[i[c].id1]||g[i[c].id2])d[c]=i[c];for(c in d)bW(c,!0),delete i[c];for(c in g)bW(c,!0),delete h[c];b.preserveOffsets||f.resetConnectionOffsets(i,d)};g.selectionPlusDummyNodes=function(){var a=b_();for(var b=0;b<a.length;b++){var c=i[a[b]];c&&(h[c.id1].du&&a.push(c.id1),h[c.id2].du&&a.push(c.id2))}return a},g.contains=function(a){function g(a,b){a&&f.push(b)}var c,d,f=[];a=e.defaults(a,{sh:"box",x:0,y:0});if(Q(a))if(a.sh==="circle"){var i=Math.min(a.w,a.h)/2;for(d in h)c=h[d],Q(c)?c.sh==="circle"?g(b.insideCircle(a.x,a.y,i,c.x,c.y,Math.min(c.w,c.h)/2),c.id):g(b.circleContains(a.x,a.y,i,c.x-c.w/2,c.y-c.h/2,c.x+c.w/2,c.y+c.h/2),c.id):g(b.insideCircle(a.x,a.y,i,c.x,c.y),c.id)}else{var j={x1:a.x-a.w/2,y1:a.y-a.h/2,x2:a.x+a.w/2,y2:a.y+a.h/2};for(d in h){c=h[d];if(Q(c))if(c.sh==="circle"){var k=Math.min(c.w,c.h)/2;g(b.rectContains(j,c.x-k,c.y-k,c.x+k,c.y+k),c.id)}else g(b.rectContains(j,c.x-c.w/2,c.y-c.h/2,c.x+c.w/2,c.y+c.h/2),c.id);else g(b.inside(j,c.x,c.y),c.id)}}return f};var cb=g.getCursor=function(a,b){var c=ci(a);return c?c:a?'url("'+b+'openhand.cur"), pointer':"auto"},cc=null,cd=null;g.getResizePrimitive=function(){return cc};var ce=new RegExp(l+"((\\S+)(?:\\-resize))$"),cf={nw:["x1","y1"],n:["y1"],ne:["x2","y1"],e:["x2"],se:["x2","y2"],s:["y2"],sw:["x1","y2"],w:["x1"]},cj=new RegExp(l+"(id[1|2])$"),ck=g.startDragger=function(a,b,c,f,j,k,l){var m=(l+"").match(cj),n=e.rawId(f);return d.createLinkEndDragger(a,g,c,h,i[n],m[1],j,k,n)},cl=g.createDragger=function(c,f,j,k,l,m,n,o,p,q,r,s){var t=p.handMode,v=e.rawId(m),w=cg(m);if(w){var x=ch(m),y=s;return d.primitiveMover(b,k,l,v,y,!0,x,n,o,function(b){a.trigger("prechange","resize");var c=h[e.rawId(m)];if(b.p==="C")c.x=l.newToOldX(b.x),c.y=l.newToOldY(b.y),c.w=c.h=2*l.undim(b.r);else{var d=l.newToOldX(b.x1),f=l.newToOldY(b.y1),g=l.newToOldX(b.x2),i=l.newToOldY(b.y2);c.x=d+Math.floor((g-d)/2),c.y=f+Math.floor((i-f)/2),c.w=g-d,c.h=i-f}})}if(v!==null&&i[v]){var z=(m+"").match(cj);return z?d.createLinkEndDragger(j,g,l,h,i[v],z[1],n,o,v):d.createLinkDragger(u,k,l,i[v],n,o,v)}return t||v!==null?d.createDefaultDragger(h,bY,k,l,m,n,o):cn(c,f,k,l,v,n,o,q,r,p.crossingBox)},cm=[["x1","y1"],["y1"],["x2","y1"],["x2"],["x2","y2"],["y2"],["x1","y2"],["x1"]],cn=function(c,d,f,g,j,k,l,m,n,o){function u(a,b){t.x1=Math.min(r,a),t.y1=Math.min(s,b),t.x2=Math.max(r,a),t.y2=Math.max(s,b)}function v(a,c,d,e){u(a,c);var f={};f.x1=g.newToOldX(t.x1),f.y1=g.newToOldY(t.y1),f.x2=g.newToOldX(t.x2),f.y2=g.newToOldY(t.y2);var j={};for(var k in h)j[k]=b.inside(f,h[k].x,h[k].y);for(var l in i)j[l]=b.inside(f,i[l]._x,i[l]._y);for(var m in j)j[m]?bV(m):d||e?p[m]||bW(m):bW(m)}function w(a,g,h,i){u(a,g);if(c){var j={},k;c.each(function(a){if(a.p!==b.primitives.line&&a.p!==b.primitives.arc&&a.p!==""){var c=b.extents(f,a);k=e.rawId(a.id),j[k]=j[k]||b.intersects(t,c)}}),d.each(function(a){k=e.rawId(a.id),j[k]=j[k]||b.inside(t,a.x,a.y)});for(var l in j)j[l]?bV(l):h||i?p[l]||bW(l):bW(l)}}if(a.trigger("dragstart","area",null,g.unscale(k),g.unscale(l),null))return;var p={};for(var q in bS)p[q]=1;var r=k,s=l,t={p:b.primitives.rect,x1:r,y1:s,x2:r,y2:s,bc:b.colours.midgrey,bw:1,fc:b.colours.blue,fi:!1},x={scrollable:!0,getCursor:function(a,b){return"crosshair"},generate:function(a){a.copyPrimitive(t)},dragMove:function(a,b,c,d){a>k||!o?v(a,b,c,d):w(a,b,c,d)},endDrag:function(b,c,d,e,f){g.cancelScroll();var h=a.trigger("dragend","area",null,g.unscale(c),g.unscale(d));h||b||bZ(),a.trigger("dragcomplete","area",null,g.unscale(c),g.unscale(d))}};return x};return g.createGestureDragger=function(b,c,d){function k(a,c,d){var e=-a*2*Math.PI/360;e*=2;var j=Math.sin(e),k=Math.cos(e);for(var l in h)h[l].x=(i[l].x-f)*k+(i[l].y-g)*j+f,h[l].y=-(i[l].x-f)*j+(i[l].y-g)*k+g;var m=b.newToOldX(c),n=b.newToOldY(d);for(var o in h)h[o].x+=m-f,h[o].y+=n-g}function l(a){a=Math.pow(a,2),b.zoomToPosition(a*e,c,d)}function q(a,b,c,d){m=a,n=b,o=c,p=d}function u(){l(m),r=r||Math.abs(n)>12,t=t||Math.abs(o-f)>s||Math.abs(p-g)>s,k(r?n:0,t?o:f,t?p:g)}function v(){for(var a in h)h[a].x=i[a].x,h[a].y=i[a].y}var e=b.zoom(),f=b.newToOldX(c),g=b.newToOldY(d),i={};for(var j in h)i[j]={x:h[j].x,y:h[j].y};var m,n,o,p;q(1,0,f,g);var r=!1,s=60,t=!1,w={animate:function(a){u()},getCursor:function(a,b){return"move"},dragMove:function(a,b,c,d){q(a,b,c,d)},endDrag:function(b,c,d,e,f){q(c,d,e,f),b?(v(),a.trigger("prechange","move"),u()):v()}};return w},g.extractStructure=function(a,b,c){return f.resetAllConnectionOffsets(i),f.extractStructure(g,a,h,i,b,c)},g.layout=function(a,b,c,d,e,g){f.layout(a,b,c,d,e,g)},g.applyVertices=function(a){for(var b in h)a[b]&&(h[b].x=a[b].x,h[b].y=a[b].y)},g.makeAnimator=function(b,c){var d=c,e={};for(var f in h)e[f]={x:h[f].x,y:h[f].y};return{animate:function(f){d-=f;var g=a.cubicEasing(Math.max(0,(c-d)/c));for(var i in h)b[i]&&(h[i].x=e[i].x+g*(b[i].x-e[i].x),h[i].y=e[i].y+g*(b[i].y-e[i].y));return d>0}}},g}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.API={});var b=typeof KeyLinesRequire!="undefined"?require("./rendering"):this.KeyLines.Rendering,c=typeof KeyLinesRequire!="undefined"?require("./view"):this.KeyLines.View,d=typeof KeyLinesRequire!="undefined"?require("./events"):this.KeyLines.Events,e=typeof KeyLinesRequire!="undefined"?require("./model"):this.KeyLines.Model,f=typeof KeyLinesRequire!="undefined"?require("./timemodel"):this.KeyLines.TimeModel,g=typeof KeyLinesRequire!="undefined"?require("./controller"):this.KeyLines.Controller,h=typeof KeyLinesRequire!="undefined"?require("./overlays"):this.KeyLines.Overlays,i=typeof KeyLinesRequire!="undefined"?require("./draggers"):this.KeyLines.Draggers;a.createAPI=function(){function t(b,c){b?p.afterChange(c):(p.render(),a.invoke(c))}function u(b){return b===!0&&(b={animate:!0}),a.defaults(b,{animate:!1,time:1e3})}var a=typeof KeyLinesRequire!="undefined"?require("./util"):KeyLines.Util,j={},k=d.createEventBus(),l,m=i.createDraggers(k),n=e.createModel(k,m),o=h.createOverlays(k,c),p=g.createController(j,k,o);p.setModel(n);var q;j.privateEventBus=function(){return k};var r=j.privateInit=function(a,b,c,d,e,f,g,h,i,j){q=e,p.assetPath(h),p.setCursorFn(f),p.setCreateCanvasFn(e),p.setImageGenFn(g),s(a,b,c,d,i),p.imageBasePath(j)},s=j.privateSetSize=function(a,d,e,f,g,h){p.makeGhostCanvas(e,f),g&&(e/=g,f/=g),l=c.createView(k,e,f,g),p.setView(l),p.setCanvas(a),p.setShadowCanvas(d.getContext("2d")),b.clearLastFont(),p.afterChange(null,h)};j.privateViewSettings=function(){return l.settings()},j.privateViewFromOldSettings=function(a,b){l.fromOldSettings(a,b)},j.privateFlashClick=function(a){k.trigger("flashclick",a)},j.privateGetMethodsWithCallbacks=function(){return["animateProperties","contains","directLayout","displayOptions","finishLayout","hide","load","merge","pan","setItem","setProperties","show","viewOptions","zoom"]},j.privateNamespaceNames=function(a){var b=[],c=j[a]();for(var d in c)d.indexOf("private")===-1&&b.push(d);return b},j.graph=function(){return n.graph},j.combo=function(){return p.combo.api},j.layoutStructure=function(a,b){return p.extractStructure(a,b)},j.finishLayout=function(a,b,c){p.finishLayout(a,b,!1,c)},j.toDataURL=function(b,d,e){function t(a){b=Math.floor(b/a),d=Math.floor(d/a)}b=Math.floor(b),d=Math.floor(d),e=a.defaults(e,{fit:"view",watermark:!0,gradient:!0,logo:!0});var f;if(e.fit==="oneToOne"){var i=p.modelExtents();i||(i={x1:0,y1:0,x2:100,y2:100});var m=10;f={x1:l.newToOldX(i.x1)-m,x2:l.newToOldX(i.x2)+m,y1:l.newToOldY(i.y1)-m,y2:l.newToOldY(i.y2)+m};var o=p.watermarkSize();if(o&&e.watermark){var r=(o.width-(f.x2-f.x1))/2;r>0&&(f.x1-=r,f.x2+=r);var s=(o.height-(f.y2-f.y1))/2;s>0&&(f.y1-=s,f.y2+=s)}b=f.x2-f.x1,d=f.y2-f.y1,e.noScale=!0}var u=16e6,v=b*d,w=v/u;if(w>1){var x=Math.sqrt(w);t(x)}var y=8e3,z=b/y;z>1&&t(z);var A=d/y;A>1&&t(A);var B=q(b,d),C=B.getContext("2d"),D=e.noScale?1:b/l.width(),E=c.createView(k,Math.floor(b/D),Math.floor(d/D)),F=h.createOverlays(k,c),G=g.createController(j,k,F);G.setCreateCanvasFn(q),G.setModel(n),G.setView(E),G.setCanvas(C),G.assetPath(p.assetPath()),G.imageBasePath(p.imageBasePath()),G.imageList(p.imageList());var H=p.displayOptions();e.watermark||(H.watermark=!1),e.gradient||(H.gradient=!1),e.logo||(H.logo=!1),G.displayOptions(H,null,!0),G.makeGhostCanvas(E.width(),E.height());var I=[];e.selection||(I=n.doSelection(),n.doSelection([]));switch(e.fit){case"chart":G.fitToModel(!1);break;case"view":E.fromOldSettings(l.settings(),!0);break;case"exact":E.fromOldSettings(l.settings(),!1);break;case"oneToOne":E.fitWorldExtents(f,!1,!1,!1,0,0)}E.scaleFactor(D),G.draw(!0);var J=B.toDataURL();return e.selection||n.doSelection(I),J},j.load=function(a,b){switch(a.type){case"LinkChart":n=e.createModel(k,m),p.setModel(n),p.load(a),p.afterChange(b);break;case"Timeline":n=f.createModel(k,m),p.setModel(n),p.load(a),p.afterChange(b);break;default:throw new Error("Unknown chart type passed to load")}},j.chartType=function(){return n.type()},j.clear=function(){k.trigger("prechange","delete"),n.load({items:[]}),p.combo.internalUse.loadUp(),p.afterChange(null,!0)},j.startDragger=function(a,b,c,d){p.startDragger(a,b,c,d)},j.merge=function(a,b){var c=p.merge(a);p.postMerge(function(){t(c,b)})},j.privateMerge=function(a,b){var c=n.merge(a);t(c,b)},j.privateEach=function(a,b){n.each(a,b)},j.privateBothEndsShown=function(a){return n.bothEndsShown(a)},j.setProperties=function(a,b,c){var d=p.setProperties(a,b);t(d,c)},j.animateProperties=function(b,c,d){c=a.defaults(c,{time:1e3,easing:"linear",queue:!0}),b=a.ensureArray(b),p.animateProperties(b,c,d)},j.getItem=function(b){if(a.isArray(b)){var c=[];for(var d=0;d<b.length;d++){var e=n.getItem(b[d]);e=e||null,c.push(e)}return c}return n?n.getItem(b):null},j.setItem=function(a,b){if(a){k.trigger("prechange","properties");var c=n.setItem(a);t(c,b)}},j.removeItem=function(a){k.trigger("prechange","delete"),p.removeItem(a),p.render()},j.privateRemoveItem=function(a){n.removeItem(a),p.render()},j.hide=function(b,c,d){k.trigger("prechange","hide"),b=a.ensureArray(b),c=u(c),c.animate?p.hide(b,c.time,function(){n.hide(b),a.invoke(d)}):(n.hide(b),p.render(),a.invoke(d))},j.hidden=function(){return n.hidden()},j.show=function(b,c,d,e){k.trigger("prechange","show"),b=a.ensureArray(b),n.show(b,c),d=u(d),d.animate?p.show(b,!0,d.time,e):(p.render(),a.invoke(e))},j.labelPosition=function(a){return n?n.labelPosition(a,l):null},j.contains=function(a){return n?n.contains(a):[]},j.serialize=function(){var a=n.serialize(l);return p.appendCombos(a),a.displayOptions=p.displayOptions(),a.viewSettings=l.settings(),a},j.worldCoordinates=function(a,b){var c=l.scale(a),d=l.scale(b);return{x:l.newToOldX(c),y:l.newToOldY(d)}},j.viewCoordinates=function(a,b){var c=l.oldToNewX(a),d=l.oldToNewY(b);return{x:l.unscale(c),y:l.unscale(d)}},j.viewOptions=function(b,c,d){if(!b)return l.settings();var e=u(c);b=a.defaults(b,{offsetX:0,offsetY:0,zoom:1}),p.setViewSettings(b,e.animate,e.time,d)},j.displayOptions=function(a,b){return p.displayOptions(a,b)},j.interactionOptions=function(a){return p.interactionOptions(a)},j.lock=function(a,b){return typeof a!="undefined"&&(v=a,a?(b=b||{},p.wait(b.wait)):p.wait(!1),p.render()),v};var v=!1;j.zoom=function(a,b,c){var d=u(b);switch(a){case"in":p.zoomIn(d.animate,d.time,c);break;case"out":p.zoomOut(d.animate,d.time,c);break;case"one":p.setZoom(1,d.animate,d.time,c);break;case"fit":p.fitToModel(d.animate,d.time,c);break;case"selection":p.fitToSelection(d.animate,d.time,c);break;case"height":p.fitModelHeight(d.animate,d.time,c)}},j.pan=function(a,b,c){var d=u(b);switch(a){case"up":p.panUp(d.animate,d.time,c);break;case"down":p.panDown(d.animate,d.time,c);break;case"left":p.panLeft(d.animate,d.time,c);break;case"right":p.panRight(d.animate,d.time,c)}},j.getLastError=function(){return k.getErrors()},j.ping=function(a,b){p.ping(a,b)},j.imagePrefix=function(a){return p.imagePrefix(a)},j.measureText=function(a,b,c,d){return p.measureText(a,b,c,d).width},j.requestRedraw=function(){p.render()},j.draw=function(a){p.draw(a)},j.drawShadow=function(){p.drawoffscreen(),p.afterDraw()},j.animate=function(a){return p.animate(a)},j.modelAnimated=function(){return n?n.animated():!1},j.randomWalk=function(){n&&n.randomWalker&&p.pushAnimation(n.randomWalker())},j.cancelAnimation=function(){p.cancelAnimation()},j.directLayout=function(a,b,c){p.layout(a,b,!1,c)},j.selection=function(b){b=a.isNullOrUndefined(b)?b:a.ensureArray(b);var c=n?n.doSelection(b):[];return p.render(),c},j.mousedown=function(a,b,c,d,e){if(v)return;p.mousedown(a,b,c,d,e)},j.mousemove=function(a,b,c,d){p.mousemove(a,b,c,d,v)},j.mouseup=function(a,b,c,d){if(v)return;p.mouseup(a,b,c,d)},j.mouseleave=function(a){if(v)return;p.mouseleave()},j.mousewheel=function(a,b,c){if(v)return;p.mousewheel(a,b,c)},j.dblclick=function(a,b,c,d){if(v)return;p.dblclick(a,b,c,d)},j.touchstart=function(a,b){if(v)return;p.touchstart(a,b)},j.touchmove=function(a,b){if(v)return;p.touchmove(a,b)},j.touchend=function(a,b){if(v)return;p.touchend(a,b)},j.touchcancel=function(a,b){if(v)return;p.touchcancel(a,b)},j.gesturestart=function(){if(v)return;p.gesturestart()},j.gesturechange=function(a,b){if(v)return;p.gesturechange(a,b)},j.gestureend=function(a,b){if(v)return;p.gestureend(a,b)},j.keyup=function(a){if(v)return;p.keyup(a)},j.keydown=function(a,b,c){if(v)return;return p.keydown(a,b,c)},j.dragover=function(a,b){p.dragover(a,b)};for(var w in k)j[w]=k[w];return j}})();


(function(){var a;typeof KeyLinesExports!="undefined"?a=exports:(this.KeyLines=this.KeyLines||{},a=this.KeyLines.Canvas={});var b=typeof KeyLinesRequire!="undefined"?require("./api"):this.KeyLines.API;a.create=function(a,c,d,e,f){function g(a,b){var c=document.createElement("canvas");return c.height=b,c.width=a,c}function h(){return new Image}function v(){var a=(new Date).getTime(),b=a>>10;b>q?(s=Math.round(r/(b>q)),r=0,q=b):r++;if(l.ready){var c=l.animate(a-p);p=a,u=u||c,u&&(u=!1,l.draw(),l.drawShadow())}window.requestAnimFrame(v)}var i=g(c,d),j=document.getElementById(a);j.parentNode.replaceChild(i,j),i.setAttribute("id",a);var k=document.getElementById(a);k.setAttribute("style","-ms-touch-action: none;");var l={},m=b.createAPI();for(var n in m)n.indexOf("private")===-1&&(l[n]=m[n]);var o=g(c,d);m.privateInit(k.getContext("2d"),o,c,d,g,function(b){document.getElementById(a).style.cursor=b},h,e,undefined,f),l.setSize=function(a,b,c){var d=m.privateViewSettings();o=g(a,b),k.width=a,k.height=b,m.privateSetSize(k.getContext("2d"),o,a,b,c,!0),m.privateViewFromOldSettings(d,!1)},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,b){window.setTimeout(a,1e3/60)}}();var p=(new Date).getTime(),q=p>>10,r=0,s=0,t,u=!1;return l.frameRate=function(){return s},l.bind("redraw",function(){u=!0}),l.canvas=!0,l.ready=!0,window.requestAnimFrame(v),l}})();

